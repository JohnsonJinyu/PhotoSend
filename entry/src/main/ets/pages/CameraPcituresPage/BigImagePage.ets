//BigImagePage.ets
import { RectInfoInPx } from '../../utils/ComponentAttrUtils';
import { AnimationProperties } from '../../CustomTransition/AnimationProperties';
import { MyNodeController, getMyNode,deleteMyNode } from '../../NodeContainer/CustomComponent';
import { CustomTransition } from '../../CustomTransition/CustomNavigationUtils';
import { ImageInfoWithPixelMap } from './CameraPicturesPage';

// æ‰©å±•å¤§å›¾é¡µå‚æ•°æ¥å£ï¼Œæ–°å¢è½¬åœºå¿…éœ€å­—æ®µ
// æ‰©å±•BigImageParamsï¼Œæ–°å¢uniqueKeyå­—æ®µ
export interface BigImageParams {
  imageInfo: ImageInfoWithPixelMap;
  cardItemInfo: RectInfoInPx; // ä¸Šä¸€é¡µç‚¹å‡»å…ƒç´ çš„ä½ç½®ä¿¡æ¯
  uniqueKey: string; // æ–°å¢ï¼šå½“å‰è½¬åœºèŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†
  doDefaultTransition: () => void; // å›è°ƒæ— éœ€ä¼ nodeï¼Œæ”¹ä¸ºé€šè¿‡keyå½’ä½
}

// å®šä¹‰Builderï¼Œç¬¦åˆè·¯ç”±é…ç½®çš„buildFunction
@Builder
export function BigImagePageBuilder() {
  BigImagePage();
}

@Component
struct BigImagePage {
  @State pageInfos: NavPathStack = new NavPathStack();
  @State animationProperties: AnimationProperties = new AnimationProperties(this.getUIContext());
  //@State myNodeController: MyNodeController | undefined = new MyNodeController(false);
  // ğŸ”¥ ä¸å†åˆå§‹åŒ–å•ä¾‹ï¼Œæ”¹ä¸ºé€šè¿‡keyåŠ¨æ€è·å–
  private myNodeController: MyNodeController | undefined;


  private pageId: number = -1;
  private shouldDoDefaultTransition: boolean = false;
  //private prePageDoFinishTransition: (myController: MyNodeController) => void = () => {}; // ä¸Šä¸€é¡µè½¬åœºå›è°ƒ
  private prePageDoFinishTransition: () => void = () => {};
  private cardItemInfo: RectInfoInPx = new RectInfoInPx(); // ä¸Šä¸€é¡µå…ƒç´ ä½ç½®
  private params: BigImageParams = {
    imageInfo: { folder: '', filename: '', pixelMap: null, thumbnail: new ArrayBuffer(0) },
    cardItemInfo: new RectInfoInPx(),
    uniqueKey:'',   // åˆå§‹åŒ–ç©ºkey
    doDefaultTransition: () => {}
  };

  // æ–°å¢ï¼šå½“å‰è½¬åœºèŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†
  private currentNodeKey: string = '';

  // ç›‘å¬é…ç½®å˜åŒ–ï¼Œè§¦å‘è½¬åœºæ³¨é”€ï¼ˆå’ŒPageTwoä¿æŒä¸€è‡´ï¼‰
  @StorageProp('windowSizeChanged') @Watch('unRegisterNavParam') windowSizeChangedTime: number = 0;
  @StorageProp('onConfigurationUpdate') @Watch('unRegisterNavParam') onConfigurationUpdateTime: number = 0;

  aboutToAppear(): void {
    // è¿ç§»ä¸Šä¸€é¡µçš„è‡ªå®šä¹‰èŠ‚ç‚¹åˆ°å½“å‰é¡µï¼ˆè½¬åœºæ ¸å¿ƒï¼‰
    //this.myNodeController = getMyNode();
    // ğŸ”¥ é€šè¿‡keyè·å–CameraPicturesPageä¼ é€’çš„èŠ‚ç‚¹ï¼ˆä¸å†è·å–å•ä¾‹ï¼‰
    this.myNodeController = getMyNode(this.currentNodeKey);
  }

  // é…ç½®å˜åŒ–æ—¶æ ‡è®°éœ€æ‰§è¡Œé»˜è®¤è½¬åœº
  private unRegisterNavParam(): void {
    this.shouldDoDefaultTransition = true;
  }

  // å¤„ç†è¿”å›é€»è¾‘ï¼ˆè¿”å›æ—¶è§¦å‘ä¸Šä¸€é¡µè½¬åœºå›è°ƒï¼Œé‡Šæ”¾èµ„æºï¼‰
  private onBackPressed(): boolean {
    if (this.shouldDoDefaultTransition) {
      CustomTransition.getInstance().unRegisterNavParam(this.pageId);
      this.pageInfos.pop();
      //this.prePageDoFinishTransition(this.myNodeController!); // é€šçŸ¥ä¸Šä¸€é¡µè¿å›èŠ‚ç‚¹
      this.prePageDoFinishTransition(); // å›è°ƒä¸Šä¸€é¡µï¼Œé€šè¿‡keyå½’ä½
      this.shouldDoDefaultTransition = false;
      return true;
    }
    this.pageInfos.pop();
    return true;
  }

  build() {
    NavDestination() {
      // å¤–å±‚Stackï¼šç»‘å®šè½¬åœºåŠ¨ç”»å±æ€§ï¼Œæ§åˆ¶ç¼©æ”¾ã€ä½ç§»ã€è£åˆ‡
      Stack({ alignContent: Alignment.TopStart }) {
        // å†…å±‚Stackï¼šæ‰¿è½½å›¾ç‰‡å’Œè½¬åœºè½½ä½“ï¼Œé¿å…å¸ƒå±€åç§»
        Stack({ alignContent: Alignment.TopStart }) {
          Column() {
            // ğŸ”¥ æ¸²æŸ“å½“å‰keyå¯¹åº”çš„èŠ‚ç‚¹ï¼ˆå’Œä¸Šä¸€é¡µç‚¹å‡»çš„å›¾ç‰‡ä¸€è‡´ï¼‰
            if (this.myNodeController){
              NodeContainer(this.myNodeController)
              // ç»‘å®šåŠ¨ç”»å±æ€§çš„é€æ˜åº¦ï¼šè½¬åœºç»“æŸåé€æ˜åº¦å˜ä¸º0ï¼Œéšè—å ä½å›¾
                .opacity(this.animationProperties.showDetailContent ? 0 : 1)
                .visibility(this.animationProperties.showDetailContent ? Visibility.None : Visibility.Visible)
                .transition(TransitionEffect.OPACITY) // å¢åŠ é€æ˜åº¦è¿‡æ¸¡ï¼Œé¿å…çªå…€
            }

            if (this.animationProperties.showDetailContent){
              Image(this.params.imageInfo.pixelMap || $r('app.media.ic_placeholder'))
                .objectFit(ImageFit.Contain)
                .padding(20)
            }

          }
          .alignItems(HorizontalAlign.Start)

        }
        .position({ y: this.animationProperties.positionValue }) // ç»‘å®šåŠ¨ç”»Yè½´ä½ç§»
      }
      .scale({ x: this.animationProperties.scaleValue, y: this.animationProperties.scaleValue })
      .translate({ x: this.animationProperties.translateX, y: this.animationProperties.translateY })
      .width(this.animationProperties.clipWidth)
      .height(this.animationProperties.clipHeight)
      .borderRadius(this.animationProperties.radius)
      // expandSafeAreaä½¿å¾—Stackåšæ²‰æµ¸å¼æ•ˆæœï¼Œå‘ä¸Šæ‰©åˆ°çŠ¶æ€æ ï¼Œå‘ä¸‹æ‰©åˆ°å¯¼èˆªæ¡
      .expandSafeArea([SafeAreaType.SYSTEM])
      // å¯¹é«˜åº¦è¿›è¡Œè£åˆ‡
      .clip(true)
    }
    .title(this.params.imageInfo.filename)
    .backgroundColor('#000000') // å¤§å›¾é¡µé»‘è‰²èƒŒæ™¯
    //.hideTitleBar(true) // éšè—æ ‡é¢˜æ ï¼Œé€‚é…ä¸€é•œåˆ°åº•è§†è§‰
    .onReady((context: NavDestinationContext) => {
      // 1. è·å–å¯¼èˆªæ ˆå’Œé¡µé¢ID
      this.pageInfos = context.pathStack;
      this.pageId = this.pageInfos.getAllPathName().length - 1;
      // 2. è§£æä¸Šä¸€é¡µä¼ é€’çš„è½¬åœºå‚æ•°
      // ğŸ”¥ è§£æå‚æ•°æ—¶ï¼Œè·å–uniqueKeyå¹¶ä¿å­˜
      const navParam = context.pathInfo?.param as BigImageParams;
      if (navParam) {
        this.params = navParam;
        this.prePageDoFinishTransition = navParam.doDefaultTransition;
        this.cardItemInfo = navParam.cardItemInfo;
        this.currentNodeKey = navParam.uniqueKey; // ä¿å­˜å½“å‰èŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†
        this.myNodeController = getMyNode(this.currentNodeKey); // é€šè¿‡keyè·å–èŠ‚ç‚¹
      }
      // 3. æ³¨å†Œè‡ªå®šä¹‰è½¬åœºåŠ¨ç”»ï¼ˆå’ŒPageTwoé€»è¾‘ä¸€è‡´ï¼‰
      CustomTransition.getInstance().registerNavParam(this.pageId,
        (isPush: boolean, isExit: boolean, transitionProxy: NavigationTransitionProxy) => {
          this.animationProperties.doAnimation(
            this.cardItemInfo, isPush, isExit, transitionProxy, 0,
            this.prePageDoFinishTransition, this.myNodeController
          );
        }, 500);
    })
    .onBackPressed(() => this.onBackPressed()) // ç»‘å®šè¿”å›é€»è¾‘
    .onDisAppear(() => {
      // é¡µé¢æ¶ˆå¤±æ—¶æ³¨é”€è½¬åœºï¼Œé‡Šæ”¾èµ„æº
      CustomTransition.getInstance().unRegisterNavParam(this.pageId);
      // ğŸ”¥ é¡µé¢æ¶ˆå¤±æ—¶ï¼Œåˆ é™¤å½“å‰èŠ‚ç‚¹ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
      deleteMyNode(this.currentNodeKey);
    });
  }
}