//BigImagePage.ets
import { RectInfoInPx } from '../../utils/ComponentAttrUtils';
import { AnimationProperties } from '../../CustomTransition/AnimationProperties';
import { MyNodeController, getMyNode,deleteMyNode } from '../../NodeContainer/CustomComponent';
import { CustomTransition } from '../../CustomTransition/CustomNavigationUtils';
import { ImageInfoWithPixelMap } from './CameraPicturesPage';
import { photoAccessHelper } from '@kit.MediaLibraryKit';
import { common } from '@kit.AbilityKit';
import { ErrorEvent, MessageEvent, url, worker} from '@kit.ArkTS'
import { CamConnectionManager } from '../../utils/CamConnectManager';

// æ‰©å±•å¤§å›¾é¡µå‚æ•°æ¥å£ï¼Œæ–°å¢è½¬åœºå¿…éœ€å­—æ®µ
// æ‰©å±•BigImageParamsï¼Œæ–°å¢uniqueKeyå­—æ®µ
export interface BigImageParams {
  imageInfo: ImageInfoWithPixelMap;
  cardItemInfo: RectInfoInPx; // ä¸Šä¸€é¡µç‚¹å‡»å…ƒç´ çš„ä½ç½®ä¿¡æ¯
  uniqueKey: string; // æ–°å¢ï¼šå½“å‰è½¬åœºèŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†
  doDefaultTransition: () => void; // å›è°ƒæ— éœ€ä¼ nodeï¼Œæ”¹ä¸ºé€šè¿‡keyå½’ä½
}


// å¤ç”¨Workerä¸­çš„æ¶ˆæ¯ç»“æ„æ¥å£ï¼ˆä¹Ÿå¯å•ç‹¬å®šä¹‰åœ¨å…±äº«æ–‡ä»¶ä¸­ï¼‰
interface DownloadMessage {
  folder: string;
  name: string;
  filesDir: string;
}
interface PostMessageData {
  type: 'success' | 'error';
  message?: string;
  savePath?: string;
}

// å®šä¹‰Builderï¼Œç¬¦åˆè·¯ç”±é…ç½®çš„buildFunction
@Builder
export function BigImagePageBuilder() {
  BigImagePage();
}


@Component
export struct BigImagePage {
  @State pageInfos: NavPathStack = new NavPathStack();
  @State animationProperties: AnimationProperties = new AnimationProperties(this.getUIContext());

  @State title: string = '';
  @State currentPictureFolder:string=''
  @State currentPictureName:string = ''
  //@State myNodeController: MyNodeController | undefined = new MyNodeController(false);
  // ğŸ”¥ ä¸å†åˆå§‹åŒ–å•ä¾‹ï¼Œæ”¹ä¸ºé€šè¿‡keyåŠ¨æ€è·å–
  private myNodeController: MyNodeController | undefined;
  // æ–°å¢ï¼šWorkerå®ä¾‹
  private downloadWorker: worker.ThreadWorker | null = null;

  private pageId: number = -1;
  private shouldDoDefaultTransition: boolean = false;
  //private prePageDoFinishTransition: (myController: MyNodeController) => void = () => {}; // ä¸Šä¸€é¡µè½¬åœºå›è°ƒ
  private prePageDoFinishTransition: () => void = () => {};
  private cardItemInfo: RectInfoInPx = new RectInfoInPx(); // ä¸Šä¸€é¡µå…ƒç´ ä½ç½®
  private params: BigImageParams = {
    imageInfo: { folder: '', filename: '', pixelMap: null, thumbnail: new ArrayBuffer(0) },
    cardItemInfo: new RectInfoInPx(),
    uniqueKey:'',   // åˆå§‹åŒ–ç©ºkey
    doDefaultTransition: () => {}
  };

  // æ–°å¢ï¼šå½“å‰è½¬åœºèŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†
  private currentNodeKey: string = '';


  // 1. å£°æ˜å•ä¾‹å˜é‡ï¼ˆç”¨äºå­˜å‚¨é€šè¿‡getInstance()è·å–çš„å®ä¾‹ï¼‰
  private camManager: CamConnectionManager | null = null;

  // ç›‘å¬é…ç½®å˜åŒ–ï¼Œè§¦å‘è½¬åœºæ³¨é”€ï¼ˆå’ŒPageTwoä¿æŒä¸€è‡´ï¼‰
  @StorageProp('windowSizeChanged') @Watch('unRegisterNavParam') windowSizeChangedTime: number = 0;
  @StorageProp('onConfigurationUpdate') @Watch('unRegisterNavParam') onConfigurationUpdateTime: number = 0;


  saveButtonOptions: SaveButtonOptions = {
    icon: SaveIconStyle.FULL_FILLED,
    text: SaveDescription.SAVE_IMAGE,
    buttonType: ButtonType.Capsule
  } // è®¾ç½®å®‰å…¨æ§ä»¶æŒ‰é’®å±æ€§ã€‚




  aboutToAppear(): void {

    // 2. é€šè¿‡é™æ€æ–¹æ³•è·å–å®ä¾‹ï¼ˆå¤ç”¨EntryAbilityåˆ›å»ºçš„å•ä¾‹ï¼‰
    this.camManager = CamConnectionManager.getInstance();
    if (!this.camManager) {
      console.error("CameraPage è·å–CamConnectionManagerå®ä¾‹å¤±è´¥ï¼");
      return;
    }


    // 2. åˆ›å»ºWorkerå¹¶è®¾ç½®æ¶ˆæ¯ç›‘å¬
    try {
      // æ³¨æ„ï¼šWorkerè„šæœ¬è·¯å¾„éœ€æ ¹æ®å®é™…é¡¹ç›®ç»“æ„è°ƒæ•´ï¼ˆç›¸å¯¹äºå½“å‰æ–‡ä»¶ï¼‰
      this.downloadWorker = new worker.ThreadWorker('../../workers/DownloadMessage.ets');

      // ç›‘å¬Workerå‘é€çš„æ¶ˆæ¯ï¼ˆå¤„ç†ä¸‹è½½ç»“æœï¼‰
      this.downloadWorker.onmessage = (e: MessageEvent<PostMessageData>) => {
        const data = e.data;
        if (data.type === 'success') {
          this.getUIContext().getPromptAction().showToast({
            message: `ä¸‹è½½æˆåŠŸï¼Œä¿å­˜è‡³ï¼š${data.savePath}`,
            duration: 2000,
            bottom: 80
          });
        } else {
          this.getUIContext().getPromptAction().showToast({
            message: `ä¸‹è½½å¤±è´¥ï¼š${data.message}`,
            duration: 2000,
            bottom: 80
          });
        }
      };

      // ç›‘å¬Workeré”™è¯¯
      this.downloadWorker.onerror = (e: ErrorEvent) => {
        console.error(`Workeré”™è¯¯ï¼š${e.message}`);
        this.getUIContext().getPromptAction().showToast({
          message: `ä¸‹è½½å¼‚å¸¸ï¼š${e.message}`,
          duration: 2000,
          bottom: 80
        });
        // é”™è¯¯å‘ç”Ÿåé”€æ¯Workerï¼Œé¿å…å¼‚å¸¸çŠ¶æ€
        this.terminateWorker();
      };
    } catch (err) {
      console.error(`åˆ›å»ºWorkerå¤±è´¥ï¼š${(err as Error).message}`);
    }


  }

  aboutToDisappear(): void {
    this.terminateWorker()
  }

  // é”€æ¯Workerï¼ˆé¡µé¢æ¶ˆå¤±æˆ–å‡ºé”™æ—¶è°ƒç”¨ï¼‰
  private terminateWorker(): void {
    if (this.downloadWorker) {
      this.downloadWorker.terminate(); // ç»ˆæ­¢Workerè¿è¡Œ
      this.downloadWorker = null;
    }
  }


  // é…ç½®å˜åŒ–æ—¶æ ‡è®°éœ€æ‰§è¡Œé»˜è®¤è½¬åœº
  private unRegisterNavParam(): void {
    this.shouldDoDefaultTransition = true;
  }

  // å¤„ç†è¿”å›é€»è¾‘ï¼ˆè¿”å›æ—¶è§¦å‘ä¸Šä¸€é¡µè½¬åœºå›è°ƒï¼Œé‡Šæ”¾èµ„æºï¼‰
  private onBackPressed(): boolean {
    if (this.shouldDoDefaultTransition) {
      CustomTransition.getInstance().unRegisterNavParam(this.pageId);
      this.pageInfos.pop();
      //this.prePageDoFinishTransition(this.myNodeController!); // é€šçŸ¥ä¸Šä¸€é¡µè¿å›èŠ‚ç‚¹
      this.prePageDoFinishTransition(); // å›è°ƒä¸Šä¸€é¡µï¼Œé€šè¿‡keyå½’ä½
      this.shouldDoDefaultTransition = false;
      return true;
    }
    this.pageInfos.pop();
    return true;
  }


  /**
   * @description ä¸‹è½½å•å¼ ç…§ç‰‡
   * */
  // å®Œå–„ä¸‹è½½æ–¹æ³•ï¼šé€šè¿‡Workeræ‰§è¡Œä¸‹è½½ï¼ˆæ›¿ä»£åŸæœ‰çš„setTimeouté€»è¾‘ï¼‰
  private async downLoadSinglePicture() {
    if (!this.currentPictureFolder || !this.currentPictureName) {
      this.getUIContext().getPromptAction().showToast({
        message: "å›¾ç‰‡ä¿¡æ¯ç¼ºå¤±ï¼Œä¸‹è½½å¤±è´¥ï¼",
        duration: 2000,
        bottom: 80
      });
      return;
    }

    if (!this.downloadWorker) {
      this.getUIContext().getPromptAction().showToast({
        message: "ä¸‹è½½æœåŠ¡åˆå§‹åŒ–å¤±è´¥",
        duration: 2000,
        bottom: 80
      });
      return;
    }

    // æ˜¾ç¤ºä¸‹è½½ä¸­æç¤º
    this.getUIContext().getPromptAction().showToast({
      message: "ä¸‹è½½ä¸­ï¼",
      duration: 3000,
      bottom: 80
    });

    try {
      // è·å–æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆä¸»çº¿ç¨‹è·å–åä¼ ç»™Workerï¼‰
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext;
      const filesDir = context.filesDir;
      if (!filesDir) {
        throw new Error("æ— æ³•è·å–æ–‡ä»¶å­˜å‚¨ç›®å½•");
      }

      // å‘Workerå‘é€ä¸‹è½½ä»»åŠ¡ï¼ˆåŒ…å«å¿…è¦å‚æ•°ï¼‰
      const message: DownloadMessage = {
        folder: this.currentPictureFolder,
        name: this.currentPictureName,
        filesDir: filesDir
      };
      this.downloadWorker.postMessage(message);
    } catch (err) {
      console.error(`ä¸‹è½½å‚æ•°å‡†å¤‡å¤±è´¥ï¼š${(err as Error).message}`);
      this.getUIContext().getPromptAction().showToast({
        message: `ä¸‹è½½å¤±è´¥ï¼š${(err as Error).message}`,
        duration: 2000,
        bottom: 80
      });
    }
  }

  build() {
    NavDestination() {
      // å¤–å±‚Stackï¼šç»‘å®šè½¬åœºåŠ¨ç”»å±æ€§ï¼Œæ§åˆ¶ç¼©æ”¾ã€ä½ç§»ã€è£åˆ‡
      Stack({ alignContent: Alignment.TopStart }) {
        // å†…å±‚Stackï¼šæ‰¿è½½å›¾ç‰‡å’Œè½¬åœºè½½ä½“ï¼Œé¿å…å¸ƒå±€åç§»
        Stack({ alignContent: Alignment.TopStart }) {
          Column() {
            // ğŸ”¥ æ¸²æŸ“å½“å‰keyå¯¹åº”çš„èŠ‚ç‚¹ï¼ˆå’Œä¸Šä¸€é¡µç‚¹å‡»çš„å›¾ç‰‡ä¸€è‡´ï¼‰
            if (this.myNodeController){
              NodeContainer(this.myNodeController)
              // ç»‘å®šåŠ¨ç”»å±æ€§çš„é€æ˜åº¦ï¼šè½¬åœºç»“æŸåé€æ˜åº¦å˜ä¸º0ï¼Œéšè—å ä½å›¾
                .opacity(this.animationProperties.showDetailContent ? 0 : 1)
                .visibility(this.animationProperties.showDetailContent ? Visibility.None : Visibility.Visible)
                .transition(TransitionEffect.OPACITY) // å¢åŠ é€æ˜åº¦è¿‡æ¸¡ï¼Œé¿å…çªå…€
            }

            if (this.animationProperties.showDetailContent){
              Image(this.params.imageInfo.pixelMap || $r('app.media.ic_placeholder'))
                .objectFit(ImageFit.Contain)
                .padding(20)

              SaveButton(this.saveButtonOptions)  //åˆ›å»ºå®‰å…¨æ§ä»¶æŒ‰é’®
                .onClick(async (event,result:SaveButtonOnClickResult)=>{
                  if (result == SaveButtonOnClickResult.SUCCESS) {
                    try {
                      let context:Context = this.getUIContext().getHostContext() as common.UIAbilityContext
                      let phAccessHelper =photoAccessHelper.getPhotoAccessHelper(context)
                      // éœ€è¦ç¡®ä¿fileUriå¯¹åº”çš„èµ„æºå­˜åœ¨ã€‚
                      let fileUri = ''
                      let assetChangeRequest: photoAccessHelper.MediaAssetChangeRequest =
                        photoAccessHelper.MediaAssetChangeRequest.createImageAssetRequest(context, fileUri);
                      await phAccessHelper.applyChanges(assetChangeRequest);
                      console.info('createAsset successfully, uri: ' + assetChangeRequest.getAsset().uri);
                    }catch (err){
                      console.error(`create asset failed with error: ${err.code}, ${err.message}`);
                    }
                  }else {
                    console.error('SaveButtonOnClickResult create asset failed');
                  }
                })
            }

          }
          .alignItems(HorizontalAlign.Start)

        }
        .position({ y: this.animationProperties.positionValue }) // ç»‘å®šåŠ¨ç”»Yè½´ä½ç§»
      }
      .scale({ x: this.animationProperties.scaleValue, y: this.animationProperties.scaleValue })
      .translate({ x: this.animationProperties.translateX, y: this.animationProperties.translateY })
      .width(this.animationProperties.clipWidth)
      .height(this.animationProperties.clipHeight)
      .borderRadius(this.animationProperties.radius)
      // expandSafeAreaä½¿å¾—Stackåšæ²‰æµ¸å¼æ•ˆæœï¼Œå‘ä¸Šæ‰©åˆ°çŠ¶æ€æ ï¼Œå‘ä¸‹æ‰©åˆ°å¯¼èˆªæ¡
      .expandSafeArea([SafeAreaType.SYSTEM])
      // å¯¹é«˜åº¦è¿›è¡Œè£åˆ‡
      .clip(true)
    }
    .title(this.title)
    .menus([
      {
        value:'downloadSinglePicture',
        icon:($r('app.media.ic_download')),
        action:()=>{
          if (this.camManager) {
            this.camManager.pauseCheck()
          }

          this.downLoadSinglePicture()
        }
      }
    ])
    .backgroundColor('#000000') // å¤§å›¾é¡µé»‘è‰²èƒŒæ™¯
    //.hideTitleBar(true) // éšè—æ ‡é¢˜æ ï¼Œé€‚é…ä¸€é•œåˆ°åº•è§†è§‰
    .onReady((context: NavDestinationContext) => {
      // 1. è·å–å¯¼èˆªæ ˆå’Œé¡µé¢ID
      this.pageInfos = context.pathStack;
      this.pageId = this.pageInfos.getAllPathName().length - 1;
      // 2. è§£æä¸Šä¸€é¡µä¼ é€’çš„è½¬åœºå‚æ•°
      // ğŸ”¥ è§£æå‚æ•°æ—¶ï¼Œè·å–uniqueKeyå¹¶ä¿å­˜
      const navParam = context.pathInfo?.param as BigImageParams;
      if (navParam) {
        this.params = navParam;
        this.title = this.params.imageInfo.filename; // è§¦å‘çŠ¶æ€æ›´æ–°
        this.currentPictureName = this.params.imageInfo.filename  // åç§°æ›´æ–°ç”¨äºä¿å­˜æ–‡ä»¶
        this.currentPictureFolder = this.params.imageInfo.folder // ç›®å½•æ›´æ–°ç”¨äºä¿å­˜æ–‡ä»¶
        this.prePageDoFinishTransition = navParam.doDefaultTransition;
        this.cardItemInfo = navParam.cardItemInfo;
        this.currentNodeKey = navParam.uniqueKey; // ä¿å­˜å½“å‰èŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†
        this.myNodeController = getMyNode(this.currentNodeKey); // é€šè¿‡keyè·å–èŠ‚ç‚¹

      }
      // 3. æ³¨å†Œè‡ªå®šä¹‰è½¬åœºåŠ¨ç”»ï¼ˆå’ŒPageTwoé€»è¾‘ä¸€è‡´ï¼‰
      CustomTransition.getInstance().registerNavParam(this.pageId,
        (isPush: boolean, isExit: boolean, transitionProxy: NavigationTransitionProxy) => {
          this.animationProperties.doAnimation(
            this.cardItemInfo, isPush, isExit, transitionProxy, 0,
            this.prePageDoFinishTransition, this.myNodeController
          );
        }, 500);
    })
    .onBackPressed(() => this.onBackPressed()) // ç»‘å®šè¿”å›é€»è¾‘
    .onDisAppear(() => {
      // é¡µé¢æ¶ˆå¤±æ—¶æ³¨é”€è½¬åœºï¼Œé‡Šæ”¾èµ„æº
      CustomTransition.getInstance().unRegisterNavParam(this.pageId);
      // ğŸ”¥ é¡µé¢æ¶ˆå¤±æ—¶ï¼Œåˆ é™¤å½“å‰èŠ‚ç‚¹ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
      deleteMyNode(this.currentNodeKey);
    });
  }
}