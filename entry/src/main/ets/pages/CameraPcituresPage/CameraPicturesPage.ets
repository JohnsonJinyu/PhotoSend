//CameraPicturesPage.ets
import nativeCamera, { ThumbnailInfo } from 'libentry.so'
import image from '@ohos.multimedia.image';
import { createMyNode, getMyNode, clearAllMyNodes } from '../../NodeContainer/CustomComponent';
import { CustomTransition } from '../../CustomTransition/CustomNavigationUtils';
import { ComponentAttrUtils, RectInfoInPx } from '../../utils/ComponentAttrUtils';
import { WindowUtils } from '../../utils/WindowUtils';

export interface ImageInfoWithPixelMap {
  folder: string;
  filename: string;
  pixelMap: image.PixelMap | null;
  // æ–°å¢ï¼šä¿å­˜åŸå§‹bufferç”¨äºå¤§å›¾ï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€è¦ï¼‰
  thumbnail: ArrayBuffer;
}


// å®šä¹‰è·³è½¬åˆ°å¤§å›¾é¡µçš„å‚æ•°æ¥å£
export interface BigImageParams {
  imageInfo: ImageInfoWithPixelMap; // åŒ…å«è¦ä¼ é€’çš„å›¾ç‰‡ä¿¡æ¯
}

@Builder
export function CameraPicturesPageBuilder() {
  CameraPicturesPage();
}


@Component
export struct CameraPicturesPage {
  @Consume('pageStack') pageStack: NavPathStack;

  private pageId:number=-1
  //@State myNodeController:MyNodeController|undefined= new MyNodeController(false)

  // ğŸ”¥ 1. åˆ é™¤å•ä¾‹nodeControllerï¼Œæ”¹ä¸ºåŠ¨æ€è·å–ï¼ˆä¸å†åˆå§‹åŒ–å•ä¾‹ï¼‰
  private currentNodeKey: string = ''; // è®°å½•å½“å‰ç‚¹å‡»çš„GridItemå”¯ä¸€æ ‡è¯†


  @State thumbnails: ThumbnailInfo[] = [];
  @State imageInfos: ImageInfoWithPixelMap[] = [];
  @State isLoading: boolean = true;
  @State errorMsg: string = '';
  @State menuItems: Array<NavigationMenuItem> = [
    {
      value: 'å¤šé€‰', action: () => {
    }
    },
    {
      value: 'èœå•', icon: $r('sys.media.ohos_ic_public_more'), action: () => {
    }
    }
  ];

  aboutToAppear(): void {
    this.loadThumbnails();

    // ğŸ”¥ 2. ç§»é™¤å•ä¾‹åˆ›å»ºé€»è¾‘ï¼Œæ”¹ä¸ºåœ¨GridItemå¾ªç¯æ—¶åŠ¨æ€åˆ›å»º
    /*let node = getMyNode()
    if (node == undefined) {
      // æ–°å»ºè‡ªå®šä¹‰èŠ‚ç‚¹
      createMyNode(this.getUIContext())
    }
    this.myNodeController =getMyNode()*/
  }

  // ğŸ”¥ 3. ä¿®æ”¹è½¬åœºå›è°ƒï¼šæ¥æ”¶å”¯ä¸€æ ‡è¯†ï¼Œç²¾å‡†å½’ä½èŠ‚ç‚¹
  /*private doFinishTransition():void{
    // pageTwo ç»“æŸè½¬åœºæ—¶ï¼Œå°†èŠ‚ç‚¹ä»pageTwoè¿å›PageOne
    this.myNodeController = getMyNode()
  }*/
  private doFinishTransition(uniqueKey: string): void {
    // å›é€€æ—¶ï¼Œé€šè¿‡keyè·å–å¯¹åº”çš„èŠ‚ç‚¹ï¼Œé‡æ–°ç»‘å®šåˆ°GridItem
    const node = getMyNode(uniqueKey);
    if (node) {
      // æ— éœ€é‡æ–°èµ‹å€¼ç»™å…¨å±€å˜é‡ï¼ŒGridItemä¼šé€šè¿‡keyè·å–æœ€æ–°èŠ‚ç‚¹
    }
  }


  private registerCustomTransition(): void {
    // æ³¨å†Œè‡ªå®šä¹‰åŠ¨ç”»åè®®
    CustomTransition.getInstance().registerNavParam(this.pageId,
      (isPush: boolean, isExit: boolean, transitionProxy: NavigationTransitionProxy) => {}, 500);
  }


  // ğŸ”¥ 4. ä¿®æ”¹GridItemç‚¹å‡»é€»è¾‘ï¼šä¼ é€’å”¯ä¸€æ ‡è¯†ï¼ˆindexï¼‰
  private onGridItemClicked(index: number): void {
    // 1. è·å–å½“å‰ç‚¹å‡»çš„å›¾ç‰‡æ•°æ®
    const currentImage = this.imageInfos[index];
    if (!currentImage) return;


    // å”¯ä¸€æ ‡è¯†ï¼šç”¨indexè½¬å­—ç¬¦ä¸²ï¼ˆå’ŒGridItemä¸­çš„keyä¸€è‡´ï¼‰
    this.currentNodeKey = index.toString();

    // 2. è·å–ç‚¹å‡»å›¾ç‰‡å…ƒç´ çš„ä½ç½®ä¿¡æ¯ï¼ˆéœ€ç»™Imageè®¾ç½®å”¯ä¸€idï¼‰
    const imageRect: RectInfoInPx = ComponentAttrUtils.getRectInfoById(
      WindowUtils.window.getUIContext(),
      `shared-image-${index}` // ä¸GridItemä¸­Imageçš„idå¯¹åº”
    );

    // 3. æ„å»ºè½¬åœºå‚æ•°ï¼ˆåŒ…å«å›¾ç‰‡æ•°æ®ã€ä½ç½®ä¿¡æ¯ã€è½¬åœºå›è°ƒï¼‰ æ–°å¢ä¼ é€’uniqueKeyï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
    const param: Record<string, Object> = {
      "imageInfo": currentImage,
      "cardItemInfo": imageRect,
      "uniqueKey": this.currentNodeKey, // ä¼ é€’ç»™BigImagePageï¼Œç”¨äºè·å–å¯¹åº”èŠ‚ç‚¹
      "doDefaultTransition": () => {
        this.doFinishTransition(this.currentNodeKey); // å›é€€æ—¶å½’ä½å½“å‰èŠ‚ç‚¹
      }
    };

    // 4. è·³è½¬å¤§å›¾é¡µå¹¶è§¦å‘è½¬åœº
    this.pageStack.pushPath({ name: 'BigImagePage', param: param });

    /*// 5. è‡ªå®šä¹‰èŠ‚ç‚¹ä»å½“å‰é¡µé¢ä¸‹æ ‘ï¼ˆè½¬åœºè¿‡ç¨‹ä¸­èŠ‚ç‚¹è¿ç§»åˆ°ç›®æ ‡é¡µï¼‰
    if (this.myNodeController) {
      this.myNodeController.onRemove();
    }*/
    // ğŸ”¥ è·å–å½“å‰ç‚¹å‡»çš„èŠ‚ç‚¹å¹¶ä¸‹æ ‘ï¼ˆä¸å†æ“ä½œå…¨å±€å•ä¾‹ï¼‰
    const currentNode = getMyNode(this.currentNodeKey);
    if (currentNode) {
      currentNode.onRemove();
    }
  }



  // åŠ è½½ç¼©ç•¥å›¾æ•°æ®
  loadThumbnails() {
    this.isLoading = true;
    nativeCamera.GetThumbnailList((err: string | null, result: ThumbnailInfo[]) => {
      if (err) {
        this.errorMsg = `è·å–å¤±è´¥ï¼š${err}`;
        this.isLoading = false;
        return;
      }

      this.convertThumbnailsToPixelMaps(result).then(() => {
        this.isLoading = false;
      }).catch(() => {
        this.isLoading = false;
      });
    });
  }

  // æ‰¹é‡è½¬æ¢ç¼©ç•¥å›¾ï¼ˆä¿®å¤forå¾ªç¯è§£æ„é—®é¢˜ï¼‰
  async convertThumbnailsToPixelMaps(thumbnails: ThumbnailInfo[]) {
    const newImageInfos: ImageInfoWithPixelMap[] = [];
    for (let i = 0; i < thumbnails.length; i++) {
      const item = thumbnails[i];
      try {
        if (!item.thumbnail || item.thumbnail.byteLength === 0) {
          throw new Error('æ— æ•ˆçš„ç¼©ç•¥å›¾æ•°æ®');
        }
        // è½¬æ¢ä¸ºPixelMapï¼ˆå¤ç”¨ä½ çš„ç°æœ‰æ–¹æ³•ï¼‰
        const pixelMap = await this.convertArrayBufferToPixelMap(item.thumbnail, item.filename);
        newImageInfos.push({
          folder: item.folder,
          filename: item.filename,
          pixelMap: pixelMap,
          thumbnail: item.thumbnail // ä¿å­˜åŸå§‹bufferï¼Œæ–¹ä¾¿å¤§å›¾ä½¿ç”¨
        });
      } catch (err) {
        console.error(`è½¬æ¢å¤±è´¥ï¼š${(err as Error).message}`);
        newImageInfos.push({
          folder: item.folder,
          filename: item.filename,
          pixelMap: null,
          thumbnail: item.thumbnail || new ArrayBuffer(0)
        });
      }
    }
    this.imageInfos = newImageInfos;
  }

  // å•ä¸ªbufferè½¬PixelMapï¼ˆä¿®å¤imageInfo.formaté—®é¢˜ï¼‰
  async convertArrayBufferToPixelMap(buffer: ArrayBuffer, filename: string): Promise<image.PixelMap> {
    const uint8Buffer = new Uint8Array(buffer);
    if (uint8Buffer.length < 2 || uint8Buffer[0] !== 0xFF || uint8Buffer[1] !== 0xD8) {
      throw new Error(`ä¸æ˜¯æœ‰æ•ˆçš„JPEGæ•°æ®`);
    }
    const imageSource = image.createImageSource(buffer);
    if (!imageSource) {
      throw new Error(`åˆ›å»ºImageSourceå¤±è´¥`);
    }
    const imageInfo = await imageSource.getImageInfo();
    if (!imageInfo || imageInfo.size.width === 0 || imageInfo.size.height === 0) {
      throw new Error(`è·å–å›¾ç‰‡ä¿¡æ¯å¤±è´¥`);
    }
    const pixelMapOptions: image.InitializationOptions = {
      size: { width: imageInfo.size.width, height: imageInfo.size.height },
      pixelFormat: image.PixelMapFormat.RGBA_8888,
      alphaType: image.AlphaType.OPAQUE,
      editable: false
    };
    const pixelMap = await imageSource.createPixelMap(pixelMapOptions);
    if (!pixelMap) {
      throw new Error(`åˆ›å»ºPixelMapå¤±è´¥`);
    }
    return pixelMap;
  }







  build() {
    NavDestination() {
      Column() {
        if (this.isLoading) {
          Column({ space: 10 }) {
            LoadingProgress().size({ width: 40, height: 40 });
            Text('æ­£åœ¨æ£€ç´¢ç…§ç‰‡...').fontSize(16);
          }.margin({ top: 50 });
        } else if (this.errorMsg) {
          Text(this.errorMsg).fontSize(16).padding(20);
        } else {
          Text(`å…±æ‰¾åˆ° ${this.imageInfos.length} å¼ ç…§ç‰‡`).fontSize(14).padding({ left: 16, top: 10 });
          Grid() {
            ForEach(this.imageInfos, (item: ImageInfoWithPixelMap, index: number) => {



              GridItem() {
                // ç”¨ Stack è®©å›¾ç‰‡å’Œ NodeContainer é‡å ï¼ˆè§†è§‰ä¸Šè¿˜æ˜¯å›¾ç‰‡ï¼ŒNodeContainer æ˜¯è½¬åœºè½½ä½“ï¼‰
                Stack() {
                  // å›¾ç‰‡ç»„ä»¶ï¼ˆç‹¬ç«‹å­˜åœ¨ï¼Œä¸åµŒå¥—åœ¨ NodeContainer å†…ï¼‰
                  Column() {
                    Image(item.pixelMap || $r('app.media.ic_placeholder'))
                      .width('100%')
                      .height('100%')
                      .objectFit(ImageFit.Cover)
                      .id(`shared-image-${index}`) // å”¯ä¸€IDï¼Œç”¨äºè·å–ä½ç½®
                  }

                  // ğŸ”¥ åŠ¨æ€åˆ›å»ºå½“å‰GridItemçš„NodeControllerå¹¶ç»‘å®š
                  // ğŸ”¥ ç›´æ¥ç”¨index.toString()ä½œä¸ºuniqueKeyï¼Œæ— éœ€å•ç‹¬å£°æ˜å˜é‡
                  NodeContainer(getMyNode(index.toString()))   // é€šè¿‡keyè·å–ä¸“å±èŠ‚ç‚¹
                    .width('100%')
                    .height('100%')
                    .onAppear(() => {
                      // èŠ‚ç‚¹æ˜¾ç¤ºæ—¶ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼ˆæ‡’åŠ è½½ï¼Œé¿å…ä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰èŠ‚ç‚¹ï¼‰
                      if (!getMyNode(index.toString())) {
                        createMyNode(this.getUIContext(), index.toString(), item.pixelMap);
                      }
                    })
                }
                // ç‚¹å‡»äº‹ä»¶ç»‘å®šåˆ° Stackï¼ˆè§¦å‘è½¬åœºï¼‰
                .onClick(() => this.onGridItemClicked(index))
                // ç§»é™¤å†—ä½™çš„ TapGestureï¼ˆé¿å…é‡å¤è§¦å‘ï¼‰
              }
              .aspectRatio(1)

            }, (item: ImageInfoWithPixelMap) => item.filename + item.folder);
          }
          // å…³é”®ï¼šè®¾ç½®4åˆ—ç½‘æ ¼ï¼Œè‡ªé€‚åº”å±å¹•å®½åº¦
          .columnsTemplate('1fr 1fr 1fr 1fr') // 4åˆ—å¹³å‡åˆ†é…å®½åº¦
          .multiSelectable(true)
          .supportAnimation(true)
          .columnsGap(2) // åˆ—é—´è·
          .rowsGap(0.01) // è¡Œé—´è·
          .height('100%')
          .width('100%')
        }
      }.width('100%').height('100%');
    }
    .title('æœºå†…ç…§ç‰‡')
    .menus(this.menuItems)
    .width('100%')
    .height('100%')
    // æ–°å¢ï¼šæ³¨å†Œè½¬åœºã€è·å–é¡µé¢ä¿¡æ¯
    .onReady((context: NavDestinationContext) => {
      this.pageStack = context.pathStack;
      this.pageId = this.pageStack.getAllPathName().length - 1;
      this.registerCustomTransition();
    })
    // æ–°å¢ï¼šæ³¨é”€è½¬åœºã€èŠ‚ç‚¹ä¸‹æ ‘
    .onDisAppear(() => {
      CustomTransition.getInstance().unRegisterNavParam(this.pageId);

      /*if (this.myNodeController) {
        this.myNodeController.onRemove();
      }*/
      // ğŸ”¥ é¡µé¢å¸è½½æ—¶ï¼Œæ¸…ç©ºæ‰€æœ‰NodeControllerï¼Œé¿å…å†…å­˜æ³„æ¼
      clearAllMyNodes();
    });
  }
}