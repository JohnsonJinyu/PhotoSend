// CameraPage.ets
import { common, Want } from '@kit.AbilityKit'

import { BusinessError } from '@ohos.base'
import { camConnectionManager, ConnectionStateResult } from '../../utils/CamConnectManager';
import { CameraHelper } from 'ets/utils/CameraHelper';

// å®šä¹‰å…·ä½“çš„è¿æ¥æ¨¡å¼ç±»å‹
type ConnectionMode = 'è“ç‰™' | 'WiFi-AP' | 'WiFi-STA';


// ç”¨äºå­˜å‚¨å•ä¸ªé€‰ä¸­å€¼ï¼ŒåŒ…å«ä¸€ä¸ª select æ•°å­—å±æ€§å’Œ set æ–¹æ³•æ¥æ›´æ–°è¯¥å€¼
class modeSelectedValue {
  select: number = 2

  set(val: number) {
    this.select = val
  }
}

// ç”¨äºå­˜å‚¨å¤šä¸ªé€‰ä¸­å€¼ï¼ŒåŒ…å«ä¸€ä¸ª select æ•°å­—æ•°ç»„å±æ€§å’Œ set æ–¹æ³•æ¥æ›´æ–°è¯¥æ•°ç»„
class modeSelectedArray {
  select: number[] = []

  set(val: number[]) {
    this.select = val
  }
}


@Component
export struct CameraPage {
  @Consume('pageStack') pageStack: NavPathStack;
  // å®šä¹‰å“åº”å¼å˜é‡(@state ç¡®ä¿UIèƒ½å¤Ÿå®æ—¶æ›´æ–°
  @State currentState: ConnectionStateResult = { state: false, message: `æœªè¿æ¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦è¿æ¥ç›¸æœºWiFi` }
  // æ–°å¢ï¼šæ§åˆ¶åŠ è½½æ§ä»¶æ˜¾ç¤ºçš„çŠ¶æ€
  @State isLoading: boolean = false;
  // çŠ¶æ€æ§åˆ¶
  @State currentConnectionMode: ConnectionMode = 'WiFi-AP'
  @State selectedModeIndex: number = 1
  // 4. çŠ¶æ€æ›´æ–°ç¤ºä¾‹ï¼ˆæ¯”å¦‚è¿æ¥æˆåŠŸ/å¤±è´¥æ—¶æ›´æ–°çŠ¶æ€ï¼‰ åœ¨ä¸‹é¢ç”¨
  // è¿æ¥æˆåŠŸæ—¶
  //this.isDeviceConnected = true;
  // è¿æ¥å¤±è´¥/æ–­å¼€æ—¶
  // this.isDeviceConnected = false;

  // è¿æ¥æ¨¡å¼é€‰é¡¹
  private modeOptions: ConnectionMode[] = ['è“ç‰™', 'WiFi-AP', 'WiFi-STA']
  // ç›¸æœºå‹å·é€‰é¡¹
  private SupportNikonModel: string[] =
    ['Zf', 'Zfc', 'Z9', 'Z8', 'Z7', 'Z7_2', 'Z6', 'Z6_2', 'Z6 III', 'Z5', 'Z50', 'Z30']
  // é¢„è®¡æ”¯æŒçš„ç›¸æœºå‚å•†
  private SupportCamManufacturer: string[] = ['Nikon', 'Sony', 'Canon']
  // è¿æ¥æ¨¡å¼æ“ä½œé€‰é¡¹åˆ—è¡¨
  // è®¾ç½®é»˜è®¤ç›¸æœºå‚å•†
  @State currentCamManufacturer: string = 'Nikon'
  // å®šä¹‰é»˜è®¤ç›¸æœºå‹å·
  @State currentCamModel: string = 'Zf'

  aboutToAppear() {
    // æ³¨å†Œç›‘å¬å™¨
    camConnectionManager.addListener(this.handleStateChange);

    // åˆå§‹åŒ– ç›´æ¥ä»åº—é‡Œè·å–å½“å‰çŠ¶æ€ï¼ˆé¦–æ¬¡åŠ è½½UIä½¿ç”¨ï¼‰
    this.currentState = camConnectionManager.getCurrentState()


    // 2. æ–°å¢ï¼šåˆå§‹åŒ–æ—¶åŒæ­¥é»˜è®¤çš„å‚å•†å’Œå‹å·åˆ°ç®¡ç†å™¨
    camConnectionManager.updateCameraInfo(this.currentCamManufacturer, this.currentCamModel);
  }

  aboutToDisappear() {
    // ç§»é™¤ç›‘å¬å™¨
    camConnectionManager.removeListener(this.handleStateChange);
  }

  // ğŸ”¥ çŠ¶æ€åŒæ­¥å›è°ƒï¼šå•ä¾‹çŠ¶æ€å˜åŒ–æ—¶è§¦å‘ï¼Œæ›´æ–°ç»„ä»¶çš„å“åº”å¼å˜é‡
  private handleStateChange = (state: boolean, message: string) => {
    // ç›´æ¥æ›´æ–° currentStateï¼Œå›  @State ä¿®é¥°ï¼ŒUIä¼šè‡ªåŠ¨åˆ·æ–°
    console.log(`UIç›‘å¬å™¨è§¦å‘ï¼šæ–°state=${state}ï¼Œæ–°message=${message}`) // ğŸ”¥ æ–°å¢æ—¥å¿—
    this.currentState = { state, message };
    // è¿æ¥çŠ¶æ€å˜åŒ–åï¼Œå…³é—­åŠ è½½æ§ä»¶
    if (this.isLoading) {
      this.isLoading = false;
    }
  };

  build() {

    Stack({ alignContent: Alignment.Center }) {
      Column({ space: 10 }) {

        //é¡¶éƒ¨å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ
        Image($r(`app.media.camera_pre_zf`))
          .width(`100%`)
          .height(300)


        // è®¾å¤‡å‹å·æ˜¾ç¤ºåŒºåŸŸ
        Row() {

          Button(this.currentCamManufacturer)
            .buttonStyle(ButtonStyleMode.NORMAL)
            .width(120)
            .fontWeight(FontWeight.Medium)
            .onClick(() => {
              this.getUIContext().showTextPickerDialog({
                range: this.SupportCamManufacturer,
                defaultPickerItemHeight: 36,
                canLoop: true,
                selected: this.selectedModeIndex,
                onAccept: (value: TextPickerResult) => {
                  if (typeof value.index == 'number') {
                    this.selectedModeIndex = value.index
                    this.currentCamManufacturer = this.SupportCamManufacturer[value.index]
                    // åŒæ­¥åˆ°ç®¡ç†å™¨ï¼šå‚å•†å˜åŒ–æ—¶æ›´æ–°
                    camConnectionManager.updateCameraInfo(this.currentCamManufacturer, this.currentCamModel);
                  }
                }

              })
            })


          Button(this.currentCamModel)
            .buttonStyle(ButtonStyleMode.NORMAL)
            .width(80)
            .fontWeight(FontWeight.Medium)
            .onClick(() => {
              this.getUIContext().showTextPickerDialog({
                range: this.SupportNikonModel,
                // selectedï¼šåˆå§‹é€‰ä¸­é¡¹çš„ç´¢å¼•ï¼Œç»‘å®šç»„ä»¶çš„çŠ¶æ€å˜é‡selectedModeIndex
                // ä½œç”¨ï¼šæ‰“å¼€å¼¹çª—æ—¶ï¼Œé»˜è®¤é€‰ä¸­ä¸Šä¸€æ¬¡ç”¨æˆ·ç¡®è®¤çš„é€‰é¡¹ï¼ˆä¿è¯çŠ¶æ€è¿è´¯æ€§ï¼‰
                selected: this.selectedModeIndex,
                onAccept: (value: TextPickerResult) => {
                  //1ã€ç¡®ä¿ç´¢å¼•æœ‰æ•ˆï¼ˆå•é€‰é¡¹é€‰é€‰æ‹©å™¨çš„indexæ˜¯numberç±»å‹ï¼‰
                  if (typeof value.index == `number`) {
                    //2ã€æ›´æ–°é€‰ä¸­ç´¢å¼•çš„çŠ¶æ€å˜é‡ï¼ˆä¸‹æ¬¡æ‰“å¼€é€‰æ‹©å…¶å®é»˜è®¤é€‰ä¸­å½“å‰é¡¹ï¼‰
                    this.selectedModeIndex = value.index
                    //3ã€æ ¹æ®ç´¢å¼•æ›´æ–°å½“å‰æ¨¡å¼çš„çŠ¶æ€å˜é‡ï¼ˆç›´æ¥å½±å“UIæ˜¾ç¤ºï¼‰
                    this.currentCamModel = this.SupportNikonModel[value.index]
                    // åŒæ­¥åˆ°ç®¡ç†å™¨ï¼šå‹å·å˜åŒ–æ—¶æ›´æ–°
                    camConnectionManager.updateCameraInfo(this.currentCamManufacturer, this.currentCamModel);
                  }
                }
              })
            })

        }


        // ğŸ”¥ è®¾å¤‡è¿æ¥çŠ¶æ€æ ï¼šç›´æ¥ä½¿ç”¨ currentStateï¼ˆå•ä¾‹åŒæ­¥è¿‡æ¥çš„çŠ¶æ€ï¼‰
        Row() {
          // æ˜¾ç¤ºè®¾å¤‡è¿æ¥çŠ¶æ€
          Text(`è®¾å¤‡çŠ¶æ€:${this.currentState.message}`)
            .fontSize(16)
            .padding(10)


          // LEDç¯ï¼šæ ¹æ® currentState.state å˜åŒ–é¢œè‰²
          Circle()
            .borderRadius(12) // åœ†è§’ä¸ºå®½åº¦çš„ä¸€åŠï¼Œç¡®ä¿æ­£åœ†
            .width(24) // è®¾ç½®å®½åº¦ä¸º24vp
            .height(24) // é«˜åº¦ä¸å®½åº¦ä¸€è‡´ï¼Œå½¢æˆæ­£åœ†
            .fill(this.currentState.state ? '#00C853' : '#F44336') //ç»¿è‰²=å·²è¿æ¥ ï¼Œçº¢è‰²=æœªè¿æ¥
            // é˜´å½±æ•ˆæœå¢å¼ºå‘å…‰æ„Ÿ
            .shadow({
              radius: 8, //é˜´å½±æ¨¡ç³ŠåŠå¾„
              color: this.currentState.state ? 'rgba(0, 200, 83, 0.6)' : 'rgba(244, 67, 54, 0.6)', // é˜´å½±é¢œè‰²ä¸ä¸»ä½“ä¸€è‡´ï¼Œé™ä½é€æ˜åº¦
              offsetX: 0,
              offsetY: 0
            })
            .animation({ duration: 300 }); //é¢œè‰²åˆ‡æ¢æ·»åŠ 300msè¿‡åº¦

        }


        Row() {

          // è·³è½¬WiFiæˆ–è“ç‰™è®¾ç½®é¡µé¢ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©è¿æ¥
          Button(`è·³è½¬WIFIè®¾ç½®`)
            .buttonStyle(ButtonStyleMode.EMPHASIZED)
            .fontSize(12)
            .height(40)
            .width(140)
            .margin({ right: 10 })
            .onClick(async () => { //å¼‚æ­¥å›è°ƒï¼Œå› ä¸ºstartAbilityå¯èƒ½éœ€è¦ç­‰å¾…ç»“æœ
              try {
                //1ã€æ›´å…·å½“å‰é€‰ä¸­çš„è¿æ¥æ¨¡å¼ï¼Œæ„é€ å¯¹åº”ç³»ç»Ÿé¡µé¢çš„want(è·³è½¬å‚æ•°)
                let targetWant: Want; // Want æ˜¯ArkUIä¸­ç”¨äºè·¨èƒ½åŠ›è·³è½¬çš„å‚æ•°å¯¹è±¡
                // 2ã€è°ƒç”¨ç³»ç»Ÿèƒ½åŠ›ï¼Œå‘èµ·è·³è½¬ï¼ˆéœ€è¦ä¼ å…¥ç»„ä»¶ä¸Šä¸‹æ–‡ï¼‰
                let context = getContext(this) as common.UIAbilityContext
                // const uiAbilityContext = getContext(this) as common.UIAbilityContext

                switch (this.currentConnectionMode) {
                  // case 1:wifi
                  case `WiFi-AP`:
                  case `WiFi-STA`:
                    targetWant = {
                      bundleName: 'com.huawei.hmos.settings',
                      abilityName: 'com.huawei.hmos.settings.MainAbility',
                      uri: 'wifi_entry',

                    };
                    break

                  //case 2:bluetooth
                  case `è“ç‰™`: {
                    targetWant = {
                      bundleName: 'com.huawei.hmos.settings',
                      abilityName: 'com.huawei.hmos.settings.MainAbility',
                      uri: 'bluetooth_entry',
                    };
                    break;
                  }
                  // é»˜è®¤æƒ…å†µï¼Œç†è®ºä¸ä¼šè§¦å‘ï¼Œå› ä¸ºæ¨¡å¼å·²ç»è¢«ç±»å‹é™å®šæ­»
                  default:
                  //promptAction.showToast({ message: `è¯·é€‰æ‹©æœ‰æ•ˆçš„è¿æ¥æ¨¡å¼` });
                    return; //ç»ˆæ­¢åç»­é€»è¾‘
                }


                if (!context) {
                  throw new Error("è·å–åº”ç”¨ä¸Šä¸‹æ–‡å¤±è´¥ï¼ˆåä¸ºè®¾å¤‡ï¼‰");
                }

                // å…³é”®è°ƒæ•´ï¼šç§»é™¤å†…å±‚catchï¼Œç»Ÿä¸€ç”¨å¤–å±‚try-catchå¤„ç†é”™è¯¯
                await context.startAbility(targetWant);

                // è·³è½¬æˆåŠŸæç¤ºï¼ˆåä¸ºè®¾å¤‡é€‚é…çš„åå¸æ ·å¼ï¼Œç”¨æˆ·ä½“éªŒæ›´ç»Ÿä¸€ï¼‰
                /*promptAction.showToast({
                  message: `å·²è·³è½¬è‡³${this.currentConnectionMode}è®¾ç½®`,
                  duration: 2000 // åä¸ºè®¾å¤‡åå¸é»˜è®¤æ˜¾ç¤º1.5ç§’ï¼Œè¿™é‡Œå»¶é•¿è‡³2ç§’ç¡®ä¿é˜…è¯»
                });*/


              } catch (error) {
                const err = error as BusinessError;
                //promptAction.showToast({ message: `è·³è½¬å¤±è´¥ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}` });
                console.error(`è·³è½¬ç³»ç»Ÿè®¾ç½®å¤±è´¥ï¼š${JSON.stringify(err)}`);
              }
            })


          Button(`æ¨¡å¼:${this.currentConnectionMode}`)
            .fontSize(12)
            .width(120)
            .height(40)
            .onClick(() => {
              this.getUIContext().showTextPickerDialog({
                // rangeï¼šé€‰æ‹©å™¨çš„é€‰é¡¹åˆ—è¡¨ï¼Œè¿™é‡Œç»‘å®šç»„ä»¶ä¸­å®šä¹‰çš„è¿æ¥æ¨¡å¼æ•°ç»„ï¼ˆ['è“ç‰™', 'WiFi-AP', 'WiFi-STA']ï¼‰
                // ä½œç”¨ï¼šå†³å®šå¼¹çª—ä¸­æ˜¾ç¤ºå“ªäº›å¯é€‰é¡¹ç›®
                range: this.modeOptions,
                // selectedï¼šåˆå§‹é€‰ä¸­é¡¹çš„ç´¢å¼•ï¼Œç»‘å®šç»„ä»¶çš„çŠ¶æ€å˜é‡selectedModeIndex
                // ä½œç”¨ï¼šæ‰“å¼€å¼¹çª—æ—¶ï¼Œé»˜è®¤é€‰ä¸­ä¸Šä¸€æ¬¡ç”¨æˆ·ç¡®è®¤çš„é€‰é¡¹ï¼ˆä¿è¯çŠ¶æ€è¿è´¯æ€§ï¼‰
                selected: this.selectedModeIndex,
                onAccept: (value: TextPickerResult) => {
                  //1ã€ç¡®ä¿ç´¢å¼•æœ‰æ•ˆï¼ˆå•é€‰é¡¹é€‰é€‰æ‹©å™¨çš„indexæ˜¯numberç±»å‹ï¼‰
                  if (typeof value.index == `number`) {
                    //2ã€æ›´æ–°é€‰ä¸­ç´¢å¼•çš„çŠ¶æ€å˜é‡ï¼ˆä¸‹æ¬¡æ‰“å¼€é€‰æ‹©å…¶å®é»˜è®¤é€‰ä¸­å½“å‰é¡¹ï¼‰
                    this.selectedModeIndex = value.index
                    //3ã€æ ¹æ®ç´¢å¼•æ›´æ–°å½“å‰æ¨¡å¼çš„çŠ¶æ€å˜é‡ï¼ˆç›´æ¥å½±å“UIæ˜¾ç¤ºï¼‰
                    this.currentConnectionMode = this.modeOptions[value.index]
                  }

                  //è®¾ç½®selectä¸ºæŒ‰ä¸‹ç¡®å®šæŒ‰é’®æ—¶å€™é€‰ä¸­é¡¹indexï¼Œè¿™æ ·å½“å¼¹çª—å†æ¬¡å¼¹å‡ºæ—¶æ˜¾ç¤ºé€‰ä¸­çš„æ˜¯ä¸Šä¸€æ¬¡ç¡®å®šçš„é€‰é¡¹
                  // ä»¥ä¸‹ä»£ç æ˜¯ä¿ç•™çš„"é€‰ä¸­å€¼å­˜å‚¨"é€»è¾‘ï¼ˆå¯æ ¹æ®å®é™…éœ€æ±‚å†³å®šæ˜¯å¦ä¿ç•™ï¼‰
                  // åˆ›å»ºå­˜å‚¨å•ä¸ªé€‰ä¸­å€¼å’Œå¤šä¸ªé€‰ä¸­å€¼çš„å®ä¾‹
                  // è®¾è®¡æ„å›¾ï¼šå…¼å®¹å•é€‰/å¤šé€‰åœºæ™¯ï¼Œç”¨ä¸åŒçš„ç±»åˆ†åˆ«å­˜å‚¨ï¼ˆè™½ç„¶å½“å‰æ˜¯å•é€‰ï¼Œä½†ä¿ç•™æ‰©å±•æ€§ï¼‰
                  let selectedVal = new modeSelectedValue()
                  let selectedArr = new modeSelectedArray()
                  // åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼ˆé¿å…ç©ºå€¼æŠ¥é”™ï¼‰
                  if (value.index) {
                    // æ ¹æ®ç´¢å¼•ç±»å‹ï¼ˆå•ä¸ªæ•°å­—/æ•°ç»„ï¼‰è°ƒç”¨ä¸åŒçš„setæ–¹æ³•å­˜å‚¨
                    // å½“å‰åœºæ™¯æ˜¯å•é€‰ï¼Œä¼šèµ°selectedVal.set()ï¼Œå°†ç´¢å¼•å­˜å…¥modeSelectedValueå®ä¾‹
                    value.index instanceof Array ? selectedArr.set(value.index) : selectedVal.set(value.index)

                  }
                  console.info("TextPickerDialog:onAccept()" + JSON.stringify(value))
                },
                onCancel: () => {
                  console.info("TextPickerDialog:onCancel()")
                },
                // onChangeï¼šç”¨æˆ·åœ¨å¼¹çª—ä¸­åˆ‡æ¢é€‰é¡¹æ—¶ï¼ˆæœªç‚¹å‡»ç¡®å®šå‰ï¼‰å®æ—¶è§¦å‘çš„å›è°ƒ
                // ä½œç”¨ï¼šå®æ—¶è·å–ç”¨æˆ·çš„é€‰æ‹©è¿‡ç¨‹ï¼ˆæ¯”å¦‚ç”¨æˆ·ä»"è“ç‰™"æ»‘åˆ°"WiFi-AP"æ—¶è§¦å‘ï¼‰
                // å½“å‰ä»…ç”¨äºæ‰“å°æ—¥å¿—ï¼Œæ–¹ä¾¿è°ƒè¯•æ—¶è§‚å¯Ÿé€‰æ‹©å˜åŒ–è¿‡ç¨‹
                onChange: (value: TextPickerResult) => {
                  console.info("TextPickerDialog:onChange()" + JSON.stringify(value))
                }

              })
            })
        }


        Button('æ‰‹åŠ¨è¿æ¥ç›¸æœº')
          .fontSize(16)
          .width(280)
          .height(40)
          .enabled(!this.currentState.state)
          .onClick(() => {

            // æå‰å®ä¾‹åŒ–CameraHelper
            const cameraHelper = CameraHelper.getInstance();

            // ä»…å½“æœªè¿æ¥æ—¶æ‰è§¦å‘è¿æ¥å¹¶æ˜¾ç¤ºåŠ è½½
            if (!this.currentState.state) {
              this.isLoading = true; // æ˜¾ç¤ºåŠ è½½æ§ä»¶
              camConnectionManager.connectCamera();
            }
          })


        Button(`é¥æ§æ‹ç…§`)
          .fontSize(20)
          .width(280)
          .height(40)
          .margin({ top: 10 })
          .onClick(() => {
            this.pageStack.pushPathByName('RemoteControl', null, true)
          })


        Button('ä¸‹è½½ç…§ç‰‡')
          .fontSize(20)
          .width(280)
          .height(40)
          .margin({ top: 10 })
          .onClick(() => {
            this.pageStack.pushPathByName('CameraPicturesPage', null, true)
          })


      }
      .width('100%')
      .height('100%')
      .backgroundColor($r('sys.color.comp_background_list_card'))


      // åŠ è½½æ§ä»¶ï¼ˆæ¡ä»¶æ¸²æŸ“ï¼‰
      if (this.isLoading) {
        Column() {
          // åŠ è½½è¿›åº¦æŒ‡ç¤ºå™¨
          LoadingProgress()
            .color('#FF0000') // ä½¿ç”¨ä¸»é¢˜ä¸»è‰²
            .size({ width: 60, height: 60 }) // æ§ä»¶å¤§å°
          // åŠ è½½æç¤ºæ–‡å­—
          Text('æ­£åœ¨è¿æ¥ç›¸æœº...')
            .fontSize(16)
            .margin({ top: 10 })
            .fontColor('#ffffff')
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.3)') // åŠé€æ˜é®ç½©ï¼Œé˜²æ­¢ç”¨æˆ·æ“ä½œ
        .justifyContent(FlexAlign.Center) // å±…ä¸­æ˜¾ç¤º
      }

    }
  }
}
