// LocalPhotoDataSource.ets
// LocalPhotoDataSourceå®ç°äº†IDataSourceæ¥å£ï¼Œç”¨äºç®¡ç†listenerç›‘å¬ï¼Œä»¥åŠé€šçŸ¥LazyForEachæ•°æ®æ›´æ–°

import fs from '@ohos.file.fs';


// å¯¼å‡ºå›¾ç‰‡æ¨¡å‹
export interface ImageInfo{
  uri:string;
  name:string;
  modifyTime:number;
  dateStr:string;
}


export class LocalPhotoDataSource implements IDataSource{

  //ç§æœ‰å˜é‡ï¼šå‚¨å­˜å›¾ç‰‡æ•°æ®ã€ç›‘å¬å™¨ã€æ–‡ä»¶è·¯å¾„
  private data:ImageInfo[]=[]
  private listeners:DataChangeListener[]=[]
  private appStoragePath:string=''


  // æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ–è·¯å¾„
  constructor(initialPath:string='') {
    this.appStoragePath = initialPath
  }


  // --------------- å®˜æ–¹ IDataSource å¿…å®ç°æ–¹æ³• ---------------
  // 1. è¿”å›æ•°æ®æ€»æ•°ï¼ˆUIå±‚ç”¨äºåˆ¤æ–­æ˜¯å¦æ— æ•°æ®ï¼‰
  totalCount(): number {
    return this.data.length
  }

  // 2. æ ¹æ®ç´¢å¼•è·å–å•ä¸ªæ•°æ®ï¼ˆLazyForEach æ¸²æŸ“æ—¶è°ƒç”¨ï¼‰
  getData(index: number): ImageInfo {
    if (index < 0 || index >= this.data.length) {
      throw new Error(`ç´¢å¼•${index}è¶…å‡ºæ•°æ®èŒƒå›´`)
    }
    return this.data[index]
  }

  // 3. æ³¨å†Œæ•°æ®å˜åŒ–ç›‘å¬å™¨ï¼ˆå®˜æ–¹è¦æ±‚ï¼šç”¨äºé€šçŸ¥UIæ•°æ®æ›´æ–°ï¼‰
  registerDataChangeListener(listener: DataChangeListener): void {
    if (!this.listeners.includes(listener)) {
      this.listeners.push(listener);
    }
  }

  // 4. æ³¨é”€æ•°æ®å˜åŒ–ç›‘å¬å™¨ï¼ˆå®˜æ–¹è¦æ±‚ï¼šé¿å…å†…å­˜æ³„æ¼ï¼‰
  unregisterDataChangeListener(listener: DataChangeListener): void {
    const index = this.listeners.indexOf(listener);
    if (index !== -1) {
      this.listeners.splice(index, 1);
    }
  }

  // ğŸ‘‡ æ–°å¢è¿™è¡Œï¼ç”¨äºå¤–éƒ¨è·å–å®Œæ•´å›¾ç‰‡æ•°ç»„ï¼ˆè¿”å›å‰¯æœ¬ï¼Œé¿å…æºæ•°æ®è¢«ä¿®æ”¹ï¼‰
  get dataList(): ImageInfo[] {
    return [...this.data]; // è§£æ„èµ‹å€¼è¿”å›å‰¯æœ¬ï¼Œå®‰å…¨æ— å‰¯ä½œç”¨
  }

  // --------------- è‡ªå®šä¹‰æ•°æ®æ“ä½œæ–¹æ³•ï¼ˆä¾›UIå±‚è°ƒç”¨ï¼‰---------------
  // 1. æ›´æ–°æ–‡ä»¶è·¯å¾„ï¼ˆUIå±‚è·¯å¾„å˜åŒ–æ—¶è°ƒç”¨ï¼‰
  updatePath(newPath: string): void {
    if (newPath !== this.appStoragePath) {
      this.appStoragePath = newPath;
    }
  }

  // 2. åŠ è½½/åˆ·æ–°å›¾ç‰‡æ•°æ®ï¼ˆæ ¸å¿ƒæ•°æ®é€»è¾‘ï¼šè¯»å–æ–‡ä»¶ã€ç­›é€‰ã€æ’åºï¼‰
  async loadData(): Promise<void> {
    if (!this.appStoragePath) {
      this.data = [];
      this.notifyDataChanged(); // é€šçŸ¥UIè·¯å¾„ä¸ºç©º
      return;
    }

    try {
      const imageFiles: ImageInfo[] = [];
      // è¯»å–åº”ç”¨ç›®å½•æ–‡ä»¶ï¼ˆçº¯æ•°æ®æ“ä½œï¼Œæ— UIï¼‰
      const fileList = await fs.listFile(this.appStoragePath);

      // ç­›é€‰å›¾ç‰‡æ–‡ä»¶ï¼ˆå¤ç”¨åŸé€»è¾‘ï¼‰
      for (const fileName of fileList) {
        if (this.isImageFile(fileName)) {
          const filePath = `${this.appStoragePath}/${fileName}`;
          const stat = await fs.stat(filePath);
          const modifyTime = stat.mtime;
          const dateStr = this.formatDate(new Date(modifyTime));

          imageFiles.push({
            uri: `file://${filePath}`,
            name: fileName,
            modifyTime: modifyTime,
            dateStr: dateStr
          });
        }
      }

      // æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼ˆçº¯æ•°æ®æ’åºï¼‰
      imageFiles.sort((a, b) => b.modifyTime - a.modifyTime);
      this.data = imageFiles;
    } catch (err) {
      console.error('æ•°æ®å±‚åŠ è½½å›¾ç‰‡å¤±è´¥: ' + JSON.stringify(err));
      this.data = [];
      throw new Error(`æ•°æ®åŠ è½½å¤±è´¥: ${JSON.stringify(err)}`); // æŠ›å‡ºé”™è¯¯ï¼Œè®©UIå±‚å¤„ç†æç¤º
    } finally {
      this.notifyDataChanged(); // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œé€šçŸ¥UIæ›´æ–°
    }
  }


  // --------------- æ•°æ®å±‚è¾…åŠ©æ–¹æ³•ï¼ˆçº¯å·¥å…·é€»è¾‘ï¼‰---------------
  private isImageFile(fileName: string): boolean {
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const ext = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
    return imageExtensions.includes(ext);
  }

  private formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = this.padZero(date.getMonth() + 1);
    const day = this.padZero(date.getDate());
    const hour = this.padZero(date.getHours());
    const minute = this.padZero(date.getMinutes());
    return `${year}-${month}-${day} ${hour}:${minute}`;
  }

  private padZero(num: number): string {
    return num < 10 ? '0' + num : num.toString();
  }

  // --------------- é€šçŸ¥UIæ•°æ®å˜åŒ–ï¼ˆå®˜æ–¹æ ‡å‡†æ–¹å¼ï¼‰---------------
  private notifyDataChanged(): void {
    this.listeners.forEach(listener => {
      listener.onDataReloaded(); // é€šçŸ¥UIï¼šæ•°æ®å·²å…¨é‡æ›´æ–°
    });
  }

}