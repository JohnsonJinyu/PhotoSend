// PhoneLocalPhotos.ets
// ä»¥Girdæ˜¾ç¤ºçš„å›¾ç‰‡é‡Œè¡¨é¡µé¢
import { promptAction } from "@kit.ArkUI";
import { ImageInfo, LocalPhotoDataSource } from './LocalPhotoDataSource';


// ðŸ‘‡ æ–°å¢žï¼šå®šä¹‰è·³è½¬è¯¦æƒ…é¡µçš„å‚æ•°æŽ¥å£ï¼ˆå’Œ LocalPhotoDetail ä¸­çš„ ReceiveParams ç»“æž„ä¸€è‡´ï¼‰
interface PhotoDetailParams {
  imageList: ImageInfo[];
  selectedIndex: number;
}

@Preview
@Component
export struct PhoneLocalPhotos {
  @Consume('pageStack') pageStack: NavPathStack;


  @State private dataSource: LocalPhotoDataSource = new LocalPhotoDataSource();
  @State isLoading: boolean = true;
  @State isRefreshing: boolean = false;
  @StorageLink('selectedIndex') selectedIndex:number = 0  // è®°å½•å½“å‰é€‰ä¸­çš„å›¾ç‰‡ç´¢å¼•ï¼ˆç”¨äºŽä¼ é€’ç»™è¯¦æƒ…é¡µï¼‰

  @Link @Watch('onPathChange') appStoragePath: string;

  // è·¯å¾„å˜åŒ–å›žè°ƒï¼ˆä¸å˜ï¼‰
  private onPathChange(newPath: string, oldPath: string) {
    console.log(`è·¯å¾„å˜åŒ–ï¼šæ—§=${oldPath}ï¼Œæ–°=${newPath}`);
    if (newPath && newPath !== oldPath) {
      this.dataSource.updatePath(newPath);
      this.loadImages();
    }
  }

  // ç»„ä»¶åˆå§‹åŒ–ï¼ˆä¸å˜ï¼‰
  async aboutToAppear() {
    if (this.appStoragePath) {
      this.dataSource.updatePath(this.appStoragePath);
      await this.loadImages();
    }
  }

  // åŠ è½½å›¾ç‰‡ï¼ˆä¸å˜ï¼‰
  private async loadImages() {
    const isInitialLoad = this.dataSource.totalCount() === 0;
    isInitialLoad ? (this.isLoading = true) : (this.isRefreshing = true);

    try {
      await this.dataSource.loadData();
    } catch (err) {
      promptAction.showToast({ message: 'åŠ è½½å›¾ç‰‡å¤±è´¥' });
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }

  // --------------- å…³é”®ï¼šç”¨ @Builder å°è£…å•ä¸ª GridItem å¸ƒå±€ï¼ˆç›´è§‚æ˜“æ‡‚ï¼‰---------------
  @Builder
  private ImageGridItem(item: ImageInfo,index:number) {
    // è¿™é‡Œå°±æ˜¯å•ä¸ª GridItem çš„å¸ƒå±€ï¼Œå’Œå¸¸è§„ UI å†™æ³•å®Œå…¨ä¸€è‡´
    GridItem() {
      Column() {
        Image(item.uri)
          .width('100%')
          .aspectRatio(1)
          .objectFit(ImageFit.Cover)
          .borderRadius(4)
          .syncLoad(false) // å¿…é¡»å¼€å¯å¼‚æ­¥åŠ è½½ï¼Œé¿å…å¡é¡¿
          .autoResize(true)
          //.priority(ImagePriority.HIGH) // æå‡ç¼“å­˜ä¼˜å…ˆçº§ï¼Œå‡å°‘é‡æ–°åŠ è½½
          .dynamicRangeMode(DynamicRangeMode.HIGH)
          .orientation(ImageRotateOrientation.AUTO)
          .geometryTransition(item.uri,{follow:false})
          .onClick(()=>{
            if (!index) {
              index=0
            }
            this.selectedIndex = index
            this.pageStack.pushPathByName("LocalPhotoDetail",
              {
                imageList:this.dataSource.dataList,
                selectedIndex: index // é€‰ä¸­ç´¢å¼•
              } as PhotoDetailParams,true)

          })


        Text(item.name)
          .fontSize(12)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 4, bottom: 8 })
          .width('100%')
          .textAlign(TextAlign.Center);
      }
      .padding(5);
    }
  }

  // --------------- UI æ¸²æŸ“ï¼ˆæ‰å¹³åŒ–ç»“æž„ï¼Œä¸€çœ¼çœ‹æ‡‚ï¼‰---------------
  build() {
    Column() {
      // åŠ è½½ä¸­æç¤º
      if (this.isLoading) {
        Progress({ value: 0, type: ProgressType.Capsule })
          .width(40)
          .height(40)
          .margin({ top: 50 });
      }
      // æ— æ•°æ®æç¤º
      else if (this.dataSource.totalCount() === 0) {
        Column() {
          Text('ðŸ“·')
            .fontSize(50)
            .margin({ bottom: 20 });
          Text('æš‚æ— å›¾ç‰‡')
            .fontSize(16)
            .fontColor('#999999');
        }
        .width('100%')
        .height('80%')
        .justifyContent(FlexAlign.Center);
      }
      // å›¾ç‰‡åˆ—è¡¨ï¼ˆæ ¸å¿ƒï¼šæ‰å¹³åŒ– LazyForEach å†™æ³•ï¼‰
      else {
        Refresh({
          refreshing: this.isRefreshing,
          promptText: "æ­£åœ¨åˆ·æ–°"
        }) {
          // 1. å¤–å±‚æ˜¯ Grid å®¹å™¨ï¼ˆå¸¸è§„å¸ƒå±€ï¼‰
          Grid() {
            // 2. Grid ç›´æŽ¥åŒ…å« LazyForEachï¼Œç”Ÿæˆ GridItem
            LazyForEach(
              this.dataSource, // ç¬¬1å‚æ•°ï¼šæ•°æ®æºï¼ˆå’Œ ForEach çš„æ•°ç»„ä½œç”¨ä¸€æ ·ï¼‰
              (item: ImageInfo,index:number) => {
                // ç¬¬2å‚æ•°ï¼šç”Ÿæˆæ¯ä¸ª GridItemï¼ˆç›´æŽ¥è°ƒç”¨å°è£…å¥½çš„ Builderï¼Œç›´è§‚ï¼ï¼‰
                this.ImageGridItem(item,index);
              },
              (item: ImageInfo) => item.uri // ç¬¬3å‚æ•°ï¼šå”¯ä¸€é”®ï¼ˆå’Œ ForEach çš„ key ä½œç”¨ä¸€æ ·ï¼‰
            )

          }
          // Grid çš„å¸ƒå±€å±žæ€§ï¼ˆå¸¸è§„å†™æ³•ï¼‰
          .columnsTemplate('1fr 1fr')
          .columnsGap(10)
          .rowsGap(10)
          .padding(10)
          .width('100%');
        }
        .refreshOffset(96)
        .pullToRefresh(true)
        .onRefreshing(() => {
          this.loadImages();
        });
      }
    }
    .width('100%')
    .height('100%');
  }
}