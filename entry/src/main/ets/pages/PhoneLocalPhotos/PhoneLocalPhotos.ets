// PhoneLocalPhotos.ets
import fs from "@ohos.file.fs"
import { promptAction } from "@kit.ArkUI";
import { uri } from "@kit.ArkTS";

// å›¾ç‰‡ä¿¡æ¯æ¨¡å‹
interface ImageInfo {
  uri: string;
  name: string;
  modifyTime: number;
  dateStr: string;
}

@Preview
@Component
export struct PhoneLocalPhotos {
  @State images: ImageInfo[] = []
  @State isLoading: boolean = true;

  // æ­£ç¡®å†™æ³•ï¼š@Watch è£…é¥°åœ¨ @Link å˜é‡ä¸Šï¼ŒæŒ‡å®šè§¦å‘çš„æ–¹æ³•å
  @Link @Watch('onPathChange') appStoragePath: string;

  // æ™®é€šæ–¹æ³•ï¼šä½œä¸º @Watch çš„å›è°ƒï¼ˆä¸éœ€è¦ä»»ä½•è£…é¥°å™¨ï¼‰
  private onPathChange(newPath: string, oldPath: string) {
    console.log(`è·¯å¾„å˜åŒ–ï¼šæ—§=${oldPath}ï¼Œæ–°=${newPath}`);
    if (newPath && newPath !== oldPath) {
      this.loadImages(); // è·¯å¾„å˜äº†å°±é‡æ–°åŠ è½½å›¾ç‰‡
    }
  }

  // ç»„ä»¶åˆå§‹åŒ–æ—¶ï¼Œå¦‚æœè·¯å¾„å·²å­˜åœ¨ï¼Œç›´æ¥åŠ è½½å›¾ç‰‡
  async aboutToAppear() {
    if (this.appStoragePath) {
      await this.loadImages();
    }
  }

  // åŠ è½½å›¾ç‰‡çš„é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
  async loadImages() {
    if (!this.appStoragePath) {
      this.isLoading = false;
      return;
    }

    try {
      this.isLoading = true;
      const imageFiles: ImageInfo[] = [];

      // è¯»å–åº”ç”¨ä¸“å±ç›®å½•ä¸‹çš„æ–‡ä»¶
      const fileList = await fs.listFile(this.appStoragePath);

      // ç­›é€‰å›¾ç‰‡æ–‡ä»¶
      for (const fileName of fileList) {
        if (this.isImageFile(fileName)) {
          const filePath = `${this.appStoragePath}/${fileName}`;
          const stat = await fs.stat(filePath);
          const modifyTime = stat.mtime;
          const dateStr = this.formatDate(new Date(modifyTime));

          imageFiles.push({
            uri:  `file://${filePath}`, // å…³é”®ï¼šæ‹¼æ¥æˆæ ‡å‡†çš„ URI æ ¼å¼
            name: fileName,
            modifyTime: modifyTime,
            dateStr: dateStr
          });
           // æ·»åŠ æ­¤è¡Œæ—¥å¿—
       //console.log(`æ‹¼æ¥çš„å›¾ç‰‡uriä¸ºï¼š${}`)
        }
      }

      // æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
      imageFiles.sort((a, b) => b.modifyTime - a.modifyTime);
      this.images = imageFiles;
    } catch (err) {
      console.error('åŠ è½½å›¾ç‰‡å¤±è´¥: ' + JSON.stringify(err));
      promptAction.showToast({ message: 'åŠ è½½å›¾ç‰‡å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // å…¶ä»–è¾…åŠ©æ–¹æ³•ï¼ˆä¿æŒä¸å˜ï¼‰
  isImageFile(fileName: string): boolean {
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const ext = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
    return imageExtensions.includes(ext);
  }

  formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = this.padZero(date.getMonth() + 1);
    const day = this.padZero(date.getDate());
    const hour = this.padZero(date.getHours());
    const minute = this.padZero(date.getMinutes());
    return `${year}-${month}-${day} ${hour}:${minute}`;
  }

  padZero(num: number): string {
    return num < 10 ? '0' + num : num.toString();
  }

  @Builder TimeLineDot(isFirst: boolean, isLast: boolean) {
    Column() {
      if (!isFirst) {
        Divider()
          .vertical(true)
          .height('100%')
          .color('#DDDDDD')
      }
      Circle()
        .width(12)
        .height(12)
        .fill('#007DFF')
      if (!isLast) {
        Divider()
          .vertical(true)
          .height('100%')
          .color('#DDDDDD')
      }
    }
    .width(12)
  }

  build() {
    // ä¿æŒä¸å˜
    Column() {
      Row() {
        Text('å›¾ç‰‡æ—¶é—´è½´')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 10, bottom: 10 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)

      if (this.isLoading) {
        Progress({ value: 0, type: ProgressType.Capsule })
          .width(40)
          .height(40)
          .margin({ top: 50 })
      }
      else if (this.images.length === 0) {
        Column() {
          Text('ğŸ“·')
            .fontSize(50)
            .margin({ bottom: 20 })
          Text('æš‚æ— å›¾ç‰‡')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .height('80%')
        .justifyContent(FlexAlign.Center)
      }
      else {
        List({ space: 10 }) {
          ForEach(this.images, (item: ImageInfo, index: number) => {
            ListItem() {
              Row() {
                this.TimeLineDot(index === 0, index === this.images.length - 1)
                Column() {
                  Text(item.dateStr)
                    .fontSize(14)
                    .fontColor('#666666')
                    .margin({ bottom: 8 })
                  Image(item.uri)
                    .width('100%')
                    .height(200)
                    .objectFit(ImageFit.Cover)
                    .borderRadius(8)
                    .margin({ bottom: 8 })
                  Text(item.name)
                    .fontSize(14)
                    .fontColor('#333333')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
                .width('90%')
                .padding({ left: 10 })
              }
              .width('100%')
              .padding({ left: 20, right: 20, top: 5, bottom: 5 })
            }
          }, (item: ImageInfo) => item.uri)
        }
        .width('100%')
        .padding({ top: 10 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}