// PhoneLocalPhotos.ets
import { promptAction } from "@kit.ArkUI";
// å¯¼å…¥æ•°æ®ç®¡ç†ç±»ã€æ¨¡åž‹ã€LazyForEachï¼ˆå®˜æ–¹å¿…éœ€ï¼‰
import {  ImageInfo, LocalPhotoDataSource } from './LocalPhotoDataSource';

@Preview
@Component
export struct PhoneLocalPhotos {
  // 1. æ³¨å…¥æ•°æ®ç®¡ç†å®žä¾‹ï¼ˆUIå±‚ä¸å­˜å‚¨æ•°æ®ï¼Œä»…æŒæœ‰æ•°æ®ç±»å¼•ç”¨ï¼‰
  @State private dataSource: LocalPhotoDataSource = new LocalPhotoDataSource();
  @State isLoading: boolean = true;
  @State isRefreshing: boolean = false;
  // è·¯å¾„å˜åŒ–æ—¶ï¼ŒåŒæ­¥æ›´æ–°åˆ°æ•°æ®å±‚
  @Link @Watch('onPathChange') appStoragePath: string;

  // 2. è·¯å¾„å˜åŒ–å›žè°ƒï¼ˆä»…é€šçŸ¥æ•°æ®å±‚æ›´æ–°è·¯å¾„ï¼Œä¸å¤„ç†æ•°æ®ï¼‰
  private onPathChange(newPath: string, oldPath: string) {
    console.log(`è·¯å¾„å˜åŒ–ï¼šæ—§=${oldPath}ï¼Œæ–°=${newPath}`);
    if (newPath && newPath !== oldPath) {
      this.dataSource.updatePath(newPath); // åŒæ­¥è·¯å¾„åˆ°æ•°æ®å±‚
      this.loadImages(); // è§¦å‘æ•°æ®åŠ è½½
    }
  }

  // 3. ç»„ä»¶åˆå§‹åŒ–ï¼ˆä»…è°ƒç”¨æ•°æ®å±‚åŠ è½½æ–¹æ³•ï¼‰
  async aboutToAppear() {
    if (this.appStoragePath) {
      this.dataSource.updatePath(this.appStoragePath); // åˆå§‹åŒ–è·¯å¾„
      await this.loadImages();
    }
  }

  // 4. åŠ è½½å›¾ç‰‡ï¼ˆä»…è°ƒç”¨æ•°æ®å±‚æ–¹æ³•ï¼Œä¸å†™ä»»ä½•æ•°æ®é€»è¾‘ï¼‰
  private async loadImages() {
    // åŒºåˆ†åˆå§‹åŒ–å’Œåˆ·æ–°çŠ¶æ€ï¼ˆUIå±‚ä»…ç®¡ç†UIçŠ¶æ€ï¼‰
    const isInitialLoad = this.dataSource.totalCount() === 0;
    isInitialLoad ? (this.isLoading = true) : (this.isRefreshing = true);

    try {
      await this.dataSource.loadData(); // è°ƒç”¨æ•°æ®å±‚åŠ è½½æ•°æ®
    } catch (err) {
      // UIå±‚ä»…å¤„ç†ç”¨æˆ·æç¤ºï¼Œä¸å¤„ç†æ•°æ®é”™è¯¯ç»†èŠ‚
      promptAction.showToast({ message: 'åŠ è½½å›¾ç‰‡å¤±è´¥' });
    } finally {
      // é‡ç½®UIçŠ¶æ€
      this.isLoading = false;
      this.isRefreshing = false;
    }
  }

  // 5. UIæ¸²æŸ“ï¼ˆä»…æ¸²æŸ“æ•°æ®ï¼Œæ— æ•°æ®æ“ä½œï¼‰
  build() {
    Column() {
      // åˆå§‹åŒ–åŠ è½½æç¤º
      if (this.isLoading) {
        Progress({ value: 0, type: ProgressType.Capsule })
          .width(40)
          .height(40)
          .margin({ top: 50 });
      }
      // æ— æ•°æ®æç¤ºï¼ˆé€šè¿‡æ•°æ®å±‚èŽ·å–æ€»æ•°ï¼‰
      else if (this.dataSource.totalCount() === 0) {
        Column() {
          Text('ðŸ“·')
            .fontSize(50)
            .margin({ bottom: 20 });
          Text('æš‚æ— å›¾ç‰‡')
            .fontSize(16)
            .fontColor('#999999');
        }
        .width('100%')
        .height('80%')
        .justifyContent(FlexAlign.Center);
      }
      // å›¾ç‰‡åˆ—è¡¨ï¼ˆå®˜æ–¹ LazyForEach æ ‡å‡†ç”¨æ³•ï¼‰
      else {
        Refresh({
          refreshing: this.isRefreshing, // ç»‘å®šæ­£ç¡®çš„åˆ·æ–°çŠ¶æ€
          promptText: "æ­£åœ¨åˆ·æ–°"
        }) {
          Grid() {
            // --------------- å®˜æ–¹ LazyForEach ä¸‰å‚æ•°ç”¨æ³• ---------------
            LazyForEach(
              this.dataSource, // ç¬¬1å‚æ•°ï¼šIDataSource å®žä¾‹ï¼ˆç±»åž‹å®Œå…¨åŒ¹é…ï¼‰
              (item: ImageInfo) => { // ç¬¬2å‚æ•°ï¼šé¡¹ç”Ÿæˆå™¨ï¼ˆä»…æ¸²æŸ“UIï¼‰
                GridItem() {
                  Column() {
                    Image(item.uri)
                      .width('100%')
                      .aspectRatio(1)
                      .objectFit(ImageFit.Cover)
                      .borderRadius(4)
                      .syncLoad(false) // å¼‚æ­¥åŠ è½½

                      .dynamicRangeMode(DynamicRangeMode.HIGH)
                      .orientation(ImageRotateOrientation.AUTO);

                    Text(item.name)
                      .fontSize(12)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .margin({ top: 4, bottom: 8 })
                      .width('100%')
                      .textAlign(TextAlign.Center);
                  }
                  .padding(5);
                }
              },
              (item: ImageInfo) => item.uri // ç¬¬3å‚æ•°ï¼šå”¯ä¸€é”®ï¼ˆä¸Žæ•°æ®å±‚ä¿æŒä¸€è‡´ï¼‰
            );
          }
          .columnsTemplate('1fr 1fr')
          .columnsGap(10)
          .rowsGap(10)
          .padding(10)
          .width('100%');
        }
        .refreshOffset(96)
        .pullToRefresh(true)
        .onRefreshing(() => {
          this.loadImages(); // ä¸‹æ‹‰åˆ·æ–°ä»…è°ƒç”¨åŠ è½½æ–¹æ³•
        });
      }
    }
    .width('100%')
    .height('100%');
  }
}