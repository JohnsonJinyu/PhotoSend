import { ImageInfo } from "./LocalPhotoDataSource";
import Constants from "../../common/constants/Constants";
import { BusinessError } from '@kit.BasicServicesKit';
import { display } from "@kit.ArkUI";


// å‚æ•°æ¥å£
interface ReceiveParams {
  imageList: ImageInfo[];
  selectedIndex: number;
}

@Builder
export function LocalPhotoDetailBuilder() {
  LocalPhotoDetail();
}

@Component
struct LocalPhotoDetail {
  private params: ReceiveParams | null = null;
  private smallScroller: Scroller = new Scroller();
  private bigScroller: Scroller = new Scroller();
  @State deviceWidth: number = Constants.DEFAULT_WIDTH || 360;
  @State smallImgWidth: number = (this.deviceWidth - Constants.LIST_ITEM_SPACE * (Constants.SHOW_COUNT - 1)) / Constants.SHOW_COUNT;
  // ğŸ”¥ ä¿®å¤ï¼šå¤§å›¾å®½åº¦=å±å¹•å®½åº¦ï¼ˆä¹‹å‰åŠ smallImgWidthæ˜¯å¤šä½™çš„ï¼Œå¯¼è‡´æ»šåŠ¨åç§»é”™è¯¯ï¼‰
  @State imageWidth: number = this.deviceWidth;
  // å“åº”å¼ç´¢å¼•ï¼ˆç”±å°å›¾Listçš„ä¸­é—´é¡¹ç´¢å¼•é©±åŠ¨ï¼ŒåŒå‘åŒæ­¥ï¼‰
  @StorageLink('selectedIndex') selectedIndex: number = 0;
  private readonly DOUBLE_NUMBER = Constants.DOUBLE_NUMBER || 2;

  aboutToAppear() {
    try {
      const displayClass = display.getDefaultDisplaySync();
      const width = displayClass?.width / displayClass.densityPixels ?? Constants.DEFAULT_WIDTH;
      this.deviceWidth = width;
      this.smallImgWidth = (width - Constants.LIST_ITEM_SPACE * (Constants.SHOW_COUNT - 1)) / Constants.SHOW_COUNT;
      this.imageWidth = width; // åŒæ­¥ä¿®å¤å¤§å›¾å®½åº¦
    } catch (error) {
      const err = error as BusinessError;
      console.error(`getDefaultDisplaySync failed, code=${err.code}, message=${err.message}`);
    }
  }

  onPageShow() {
    if (this.params && this.params.imageList.length > 0) {
      this.selectedIndex = this.params.selectedIndex;
      // ğŸ”¥ ç®€åŒ–ï¼šå°å›¾Listä¼šè‡ªåŠ¨å¯¹é½ä¸­å¿ƒï¼Œåªéœ€åŒæ­¥å¤§å›¾ä½ç½®
      this.bigScroller.scrollTo({
        xOffset: this.selectedIndex * this.imageWidth,
        yOffset: 0,
        animation: { duration: 0 }
      });
    }
  }

  // ğŸ”¥ æ ¸å¿ƒç®€åŒ–ï¼šå°å›¾ç‚¹å‡»åï¼Œç›´æ¥è®¾ç½®ç´¢å¼•ï¼ŒListè‡ªåŠ¨æ»šåŠ¨åˆ°ä¸­å¿ƒï¼ˆæ— éœ€æ‰‹åŠ¨è®¡ç®—åç§»ï¼‰
  private smallImgClickAction(index: number): void {
    if (index === this.selectedIndex) return;
    this.selectedIndex = index;
    // åŒæ­¥å¤§å›¾ä½ç½®
    this.bigScroller.scrollTo({
      xOffset: index * this.imageWidth,
      yOffset: 0,
      animation: { duration: 150, curve: Curve.EaseOut }
    });
  }

  // ğŸ”¥ å¤§å›¾æ»šåŠ¨åŒæ­¥å°å›¾ï¼šç›´æ¥é€šè¿‡åç§»é‡è®¡ç®—ç´¢å¼•ï¼ŒåŒæ­¥åå°å›¾è‡ªåŠ¨å±…ä¸­
  private onBigScroll(xOffset: number): void {
    if (!this.params?.imageList || this.params.imageList.length === 0) return;
    // ç²¾ç¡®è®¡ç®—å½“å‰å¤§å›¾ç´¢å¼•ï¼ˆå‘ä¸‹å–æ•´é¿å…è¯¯å·®ï¼‰
    const currentIndex = Math.floor(xOffset / this.imageWidth);
    const validIndex = Math.max(0, Math.min(currentIndex, this.params.imageList.length - 1));
    if (validIndex !== this.selectedIndex) {
      this.selectedIndex = validIndex;
    }
  }

  // å°å›¾Builderï¼šä¸­é—´é¡¹é«˜äº®ï¼ˆä¿ç•™è¾¹æ¡†ï¼Œå¯é€‰åŠ ç¼©æ”¾å¢å¼ºè§†è§‰æ•ˆæœï¼‰
  @Builder
  private SmallImgItemBuilder(item: ImageInfo, index: number): void {
    Image(item.uri)
      .width(this.smallImgWidth)
      .height(this.smallImgWidth)
      .orientation(ImageRotateOrientation.AUTO)
      .aspectRatio(1)
      .objectFit(ImageFit.Cover)
      .borderRadius(4)
      .backgroundColor('rgba(0,0,0,0.3)')
      // ğŸ”¥ ä¸­é—´é¡¹é«˜äº®ï¼šç´¢å¼•åŒ¹é…æ—¶æ˜¾ç¤ºè¾¹æ¡†ï¼ˆå¯é€‰åŠ .scaleæ”¾å¤§ï¼‰
      .borderWidth(this.selectedIndex === index ? 3 : 0)
      .borderColor('#ffffff')
      .borderStyle(BorderStyle.Solid)
      // å¯é€‰ï¼šä¸­é—´é¡¹è½»å¾®æ”¾å¤§ï¼Œå¢å¼ºè§†è§‰èšç„¦ï¼ˆç±»ä¼¼ç¤ºä¾‹çš„å­—ä½“æ”¾å¤§ï¼‰
     // .scale(this.selectedIndex === index ? 1.05 : 1.0)
      //.transition(Transition.all(150)) // ç¼©æ”¾è¿‡æ¸¡åŠ¨ç”»
      .onClick(() => this.smallImgClickAction(index));
  }

  build() {
    NavDestination() {
      Stack({ alignContent: Alignment.Bottom }) {
        // --------------- å¤§å›¾åŒºåŸŸï¼ˆä¿æŒåŒå‘åŒæ­¥ï¼‰---------------
        List({ scroller: this.bigScroller }) {
          ForEach(
            this.params?.imageList || [],
            (item: ImageInfo) => {
              ListItem() {
                Image(item.uri)
                  .width('100%')
                  .height('100%')
                  .orientation(ImageRotateOrientation.AUTO)
                  .objectFit(ImageFit.Contain)
                  .backgroundColor('#000');
              }
              .width(this.imageWidth) // å¤§å›¾å®½åº¦=å±å¹•å®½åº¦ï¼ˆä¿®å¤åï¼‰
            },
            (item: ImageInfo) => item.uri
          )
        }
        .scrollSnapAlign(ScrollSnapAlign.CENTER)
        .onDidScroll((xOffset: number, scrollState: ScrollState) => {
          if (scrollState === ScrollState.Scroll || scrollState === ScrollState.Fling) {
            this.onBigScroll(xOffset);
          }
        })
        .scrollBar(BarState.Off)
        .width('100%')
        .height('100%')
        .padding({ bottom: this.smallImgWidth + 20 }) // é¢„ç•™å°å›¾åŒºåŸŸ
        .listDirection(Axis.Horizontal);

        // --------------- å°å›¾åŒºåŸŸï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šå‚è€ƒç¤ºä¾‹æ€è·¯ï¼‰---------------
        List({
          scroller: this.smallScroller,
          space: Constants.LIST_ITEM_SPACE,
        }) {
          ForEach(
            this.params?.imageList || [],
            (item: ImageInfo, index: number) => {
              ListItem() {
                this.SmallImgItemBuilder(item, index);
              }
              .width(this.smallImgWidth)
              .aspectRatio(1)
              .padding(1);
            },
            (item: ImageInfo) => item.uri
          )
        }
        .listDirection(Axis.Horizontal)
        // ğŸ”¥ å…³é”®1ï¼šæ»šåŠ¨åè‡ªåŠ¨å¯¹é½ä¸­å¿ƒï¼ˆç³»ç»ŸåŸç”Ÿå¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨è®¡ç®—ï¼‰
        .scrollSnapAlign(ScrollSnapAlign.CENTER)
        // ğŸ”¥ å…³é”®2ï¼šæ»šåŠ¨æ—¶è·å–ä¸­é—´é¡¹ç´¢å¼•ï¼Œç›´æ¥åŒæ­¥åˆ°selectedIndex
        .onScrollIndex((_firstIndex: number, _lastIndex: number, centerIndex: number) => {
          if (this.params?.imageList && centerIndex >= 0 && centerIndex < this.params.imageList.length) {
            this.selectedIndex = centerIndex;
            // åŒæ­¥å¤§å›¾ä½ç½®ï¼ˆæ»šåŠ¨è¿‡ç¨‹ä¸­å®æ—¶åŒæ­¥ï¼‰
            this.bigScroller.scrollTo({
              xOffset: centerIndex * this.imageWidth,
              yOffset: 0,
              animation: { duration: 0 } // æ— åŠ¨ç”»ï¼Œé¿å…å†²çª
            });
          }
        })
        .scrollBar(BarState.Off)
        .margin({ top: 16, bottom: 16 })
        .height(this.smallImgWidth + 12) // é¢„ç•™è¾¹æ¡†+ç¼©æ”¾ç©ºé—´
        .width('100%');
      }
      .width('100%')
      .height('100%');
    }
    .title(this.params?.imageList[this.selectedIndex]?.name || 'å›¾ç‰‡è¯¦æƒ…')
    .backgroundColor('#000')
    .hideBackButton(false)
    .onReady((ctx: NavDestinationContext) => {
      try {
        this.params = ctx.pathInfo.param as ReceiveParams;
        if (this.params) {
          this.selectedIndex = this.params.selectedIndex;
          // åˆå§‹åŒ–å¤§å›¾ä½ç½®ï¼ˆå°å›¾ç”±ç³»ç»Ÿè‡ªåŠ¨å±…ä¸­ï¼‰
          this.bigScroller.scrollTo({
            xOffset: this.selectedIndex * this.imageWidth,
            yOffset: 0,
            animation: { duration: 0 }
          });
        }
      } catch (e) {
        const err = e as BusinessError;
        console.error(`å‚æ•°è§£æå¼‚å¸¸: code=${err.code}, message=${err.message}`);
      }
    });
  }
}