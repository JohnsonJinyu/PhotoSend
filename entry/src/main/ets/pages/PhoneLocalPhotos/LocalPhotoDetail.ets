// LocalPhotoDetail.ets
// ä»¥åŒListæ˜¾ç¤ºçš„å›¾ç‰‡è¯¦æƒ…é¡µ
import { ImageInfo } from "./LocalPhotoDataSource";
import Constants from "../../common/constants/Constants"


enum ScrollTypeEnum {
  STOP = 'onScrollStop',
  SCROLL = 'onScroll'
}


// ğŸ‘‡ ç¬¬ä¸€æ­¥ï¼šç»Ÿä¸€å‚æ•°æ¥å£ï¼ˆå’Œåˆ—è¡¨é¡µ PhotoDetailParams å®Œå…¨ä¸€è‡´ï¼‰
interface ReceiveParams {
  imageList: ImageInfo[]; // å®Œæ•´å›¾ç‰‡æ•°ç»„
  selectedIndex: number;  // é€‰ä¸­ç´¢å¼•
}




@Builder
export function LocalPhotoDetailBuilder() {
  LocalPhotoDetail();
}

@Component
struct LocalPhotoDetail{
  // 3. æ¥æ”¶å‚æ•°ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼Œä»è·¯ç”±è·å–ï¼‰
  private params: ReceiveParams | null = null;




  // åŒListå…±ç”¨Scrollerï¼Œå®ç°è”åŠ¨
  private smallScroller:Scroller = new Scroller()
  private bigScroller:Scroller = new Scroller()
  @State deviceWidth: number = Constants.DEFAULT_WIDTH || 360; // é»˜è®¤å®½åº¦ï¼ˆé€‚é…Constantsï¼‰
  @State smallImgWidth: number = (this.deviceWidth - Constants.LIST_ITEM_SPACE * (Constants.SHOW_COUNT - 1)) / Constants.SHOW_COUNT;
  @State imageWidth: number = this.deviceWidth; // å¤§å›¾å®½åº¦=å±å¹•å®½åº¦ï¼ˆç®€åŒ–å®˜æ–¹é€»è¾‘ï¼‰
  @StorageLink('selectedIndex') selectedIndex: number = 0;



  // 5. å¤åˆ¶å®˜æ–¹ç»„ä»¶åˆå§‹åŒ–é€»è¾‘ï¼ˆè·å–å±å¹•å®½åº¦ï¼‰
  aboutToAppear() {
    try {
      // è‹¥Constantsä¸­æ²¡æœ‰DEFAULT_WIDTHï¼Œå¯æ‰‹åŠ¨è®¾ç½®ä¸º360æˆ–é€šè¿‡display APIè·å–ï¼ˆå‚è€ƒå®˜æ–¹ï¼‰
      this.smallImgWidth = (this.deviceWidth - Constants.LIST_ITEM_SPACE * (Constants.SHOW_COUNT - 1)) / Constants.SHOW_COUNT;
      this.imageWidth = this.deviceWidth;
    } catch (error) {
      console.error(`åˆå§‹åŒ–å¤±è´¥: ${JSON.stringify(error)}`);
    }
  }


  // 6. é¡µé¢æ˜¾ç¤ºæ—¶ï¼ŒåŒæ­¥æ»šåŠ¨åˆ°é€‰ä¸­ç´¢å¼•ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
  onPageShow() {
    if (this.params) {
      this.selectedIndex = this.params.selectedIndex;
      this.smallScroller.scrollToIndex(this.selectedIndex);
      this.bigScroller.scrollToIndex(this.selectedIndex);
    }
  }

  // 7. å°å›¾ç‚¹å‡»äº‹ä»¶ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼šåˆ‡æ¢é€‰ä¸­ç´¢å¼•ï¼ŒåŒæ­¥åŒListï¼‰
  private smallImgClickAction(index: number): void {
    this.selectedIndex = index;
    this.smallScroller.scrollToIndex(index);
    this.bigScroller.scrollToIndex(index);
  }


  // 8. å°å›¾æ»šåŠ¨è”åŠ¨é€»è¾‘ï¼ˆå®Œå…¨å¤åˆ¶å®˜æ–¹è®¡ç®—æ–¹å¼ï¼‰
  private smallScrollAction(type: ScrollTypeEnum): void {
    const smallItemWidth = this.smallImgWidth + Constants.LIST_ITEM_SPACE;
    // è®¡ç®—å½“å‰æ»šåŠ¨åˆ°çš„ç´¢å¼•
    this.selectedIndex = Math.round(((this.smallScroller.currentOffset().xOffset as number) + smallItemWidth / 2) / smallItemWidth);
    if (type === ScrollTypeEnum.SCROLL) {
      // æ»šåŠ¨ä¸­ï¼šåŒæ­¥å¤§å›¾ä½ç½®
      this.bigScroller.scrollTo({ xOffset: this.selectedIndex * this.imageWidth, yOffset: 0 });
    } else {
      // æ»šåŠ¨åœæ­¢ï¼šæ ¡å‡†å°å›¾ä½ç½®
      this.smallScroller.scrollTo({ xOffset: this.selectedIndex * smallItemWidth, yOffset: 0 });
    }
  }

  // 9. å¤§å›¾æ»šåŠ¨è”åŠ¨é€»è¾‘ï¼ˆå®Œå…¨å¤åˆ¶å®˜æ–¹è®¡ç®—æ–¹å¼ å¤§å›¾æ»šåŠ¨è”åŠ¨é€»è¾‘ï¼ˆå®Œå…¨å¤åˆ¶å®˜æ–¹è®¡ç®—æ–¹å¼ï¼‰
  private bigScrollAction(type: ScrollTypeEnum): void {
    const smallItemWidth = this.smallImgWidth + Constants.LIST_ITEM_SPACE;
    // è®¡ç®—å½“å‰æ»šåŠ¨åˆ°çš„ç´¢å¼•
    this.selectedIndex = Math.round(((this.bigScroller.currentOffset().xOffset as number) + this.imageWidth / 2) / this.imageWidth);
    if (type === ScrollTypeEnum.SCROLL) {
      // æ»šåŠ¨ä¸­ï¼šåŒæ­¥å°å›¾ä½ç½®
      this.smallScroller.scrollTo({ xOffset: this.selectedIndex * smallItemWidth, yOffset: 0 });
    } else {
      // æ»šåŠ¨åœæ­¢ï¼šæ ¡å‡†å¤§å›¾ä½ç½®
      this.bigScroller.scrollTo({ xOffset: this.selectedIndex * this.imageWidth, yOffset: 0 });
    }
  }



  // 10. å°å›¾Itemæ„å»ºå™¨ï¼ˆå’Œå®˜æ–¹@Builderé€»è¾‘ä¸€è‡´ï¼‰
  @Builder
  private SmallImgItemBuilder(item: ImageInfo, index: number) {
    Image(item.uri)
      .width(this.smallImgWidth)
      .height(this.smallImgWidth)
      .aspectRatio(1)
      .objectFit(ImageFit.Cover)
      .borderRadius(4)
      // é€‰ä¸­é¡¹é«˜äº®è¾¹æ¡†ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
      .borderWidth(this.selectedIndex === index ? 2 : 0)
      .borderColor('#ffffff')
      .onClick(() => this.smallImgClickAction(index));
  }




  build() {
    NavDestination() {
      // 11. å¤åˆ¶å®˜æ–¹Stackå¸ƒå±€ï¼ˆåŒListå åŠ ï¼Œå°å›¾åœ¨åº•éƒ¨ï¼‰
      Stack({ alignContent: Alignment.Bottom }) {
        // --------------- å¤§å›¾Listï¼ˆå®Œå…¨å¯¹é½å®˜æ–¹ï¼‰---------------
        List({
          scroller: this.bigScroller,
          initialIndex: this.selectedIndex
        }) {
          // ForEachç»‘å®šå®Œæ•´å›¾ç‰‡æ•°ç»„ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
          ForEach(
            this.params?.imageList || [],
            (item: ImageInfo) => {
              ListItem() {
                Image(item.uri)
                  .width(this.imageWidth)
                  .height('100%')
                  .objectFit(ImageFit.Contain)
                  .backgroundColor('#000');
              }
              .padding({ left: 16, right: 16 }) // å·¦å³å†…è¾¹è·ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
            },
            (item: ImageInfo) => item.uri // å”¯ä¸€é”®ï¼ˆå®˜æ–¹è¦æ±‚ï¼‰
          )
        }
        // æ¨ªå‘æ»šåŠ¨ï¼ˆæ ¸å¿ƒï¼šå®˜æ–¹æ˜¯æ¨ªå‘ï¼Œä¸æ˜¯çºµå‘ï¼‰
        .listDirection(Axis.Horizontal)
        // æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼ˆè”åŠ¨æ ¸å¿ƒï¼Œå®Œå…¨å¤åˆ¶å®˜æ–¹ï¼‰
        .onDidScroll((_, scrollState) => {
          if (scrollState === ScrollState.Fling) {
            this.bigScrollAction(ScrollTypeEnum.SCROLL);
          }
        })
        .onScrollStop(() => this.bigScrollAction(ScrollTypeEnum.STOP))
        .scrollBar(BarState.Off) // éšè—æ»šåŠ¨æ¡ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
        .width('100%')
        .height('100%')
        .padding({ bottom: this.smallImgWidth + 20 }); // åº•éƒ¨å†…è¾¹è·ï¼Œé¿å…é®æŒ¡å°å›¾

        // --------------- å°å›¾Listï¼ˆå®Œå…¨å¯¹é½å®˜æ–¹ï¼‰---------------
        List({
          scroller: this.smallScroller,
          space: Constants.LIST_ITEM_SPACE,
          initialIndex: this.selectedIndex
        }) {
          // ForEachç»‘å®šå®Œæ•´å›¾ç‰‡æ•°ç»„ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
          ForEach(
            this.params?.imageList || [],
            (item: ImageInfo, index: number) => {
              ListItem() {
                this.SmallImgItemBuilder(item, index); // è°ƒç”¨@Builderæ„å»ºå°å›¾
              }
              .width(this.smallImgWidth)
            },
            (item: ImageInfo) => item.uri // å”¯ä¸€é”®ï¼ˆå®˜æ–¹è¦æ±‚ï¼‰
          )
        }
        // æ¨ªå‘æ»šåŠ¨ï¼ˆæ ¸å¿ƒï¼šå®˜æ–¹æ˜¯æ¨ªå‘ï¼‰
        .listDirection(Axis.Horizontal)
        // æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼ˆè”åŠ¨æ ¸å¿ƒï¼Œå®Œå…¨å¤åˆ¶å®˜æ–¹ï¼‰
        .onDidScroll((_, scrollState) => {
          if (scrollState === ScrollState.Fling) {
            this.smallScrollAction(ScrollTypeEnum.SCROLL);
          }
        })
        .onScrollStop(() => this.smallScrollAction(ScrollTypeEnum.STOP))
        .scrollBar(BarState.Off) // éšè—æ»šåŠ¨æ¡ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
        .width('100%')
        .height(this.smallImgWidth)
        .padding({ left: 16, right: 16, bottom: 16 }) // å†…è¾¹è·ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
        .backgroundColor('rgba(0,0,0,0.7)'); // åŠé€æ˜èƒŒæ™¯ï¼ˆå’Œå®˜æ–¹ä¸€è‡´ï¼‰
      }
    }
    // æ ‡é¢˜æ˜¾ç¤ºå½“å‰å›¾ç‰‡åç§°ï¼ˆä¿®å¤ä¹‹å‰çš„é”™è¯¯ï¼šä»imageListä¸­å–å½“å‰ç´¢å¼•çš„nameï¼‰
    .title(this.params?.imageList[this.selectedIndex]?.name || 'å›¾ç‰‡è¯¦æƒ…')
    .backgroundColor('#000')
    .hideBackButton(false)
    // 12. æ­£ç¡®æ¥æ”¶è·¯ç”±å‚æ•°ï¼ˆå’Œåˆ—è¡¨é¡µPhotoDetailParamså¯¹åº”ï¼‰
    .onReady((ctx: NavDestinationContext) => {
      try {
        this.params = ctx.pathInfo.param as ReceiveParams;
        // åˆå§‹åŒ–é€‰ä¸­ç´¢å¼•
        this.selectedIndex = this.params?.selectedIndex || 0;
      } catch (e) {
        console.error(`å‚æ•°è§£æå¼‚å¸¸: ${JSON.stringify(e)}`);
      }
    });
  }
}