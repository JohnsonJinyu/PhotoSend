//RemoteControl.ets
import nativeCamera from 'libentry.so'
import { IsoDialog } from 'ets/component/CameraControlDialog/IsoDialog'
import { ShutterSpeedDialog } from 'ets/component/CameraControlDialog/ShutterSpeedDialog'
import { image } from '@kit.ImageKit';
import { cameraParamManager, ParamOption } from '../../utils/tools/CameraParamManager'
import { ApertureDialog } from '../../component/CameraControlDialog/ApertureDialog';
import { FocusModeDialog } from '../../component/CameraControlDialog/FocusModeDialog';
import { ExposureCompensationDialog } from '../../component/CameraControlDialog/ExposureCompensationDialog';
import { WhiteBalanceDialog } from '../../component/CameraControlDialog/WhiteBalanceDialog';
import { ExposureMeterModeDialog } from '../../component/CameraControlDialog/ExposureMeterModeDialog';
import { ExposureModeDialog } from '../../component/CameraControlDialog/ExposureModeDialog';
import { CamConnectionManager } from '../../utils/tools/CamConnectManager';
import { ConnectionStateResult } from '../../utils/tools/cam_connect_type';


@Builder
export function RemoteControlBuilder() {
  RemoteControl();
}


@Component
export struct RemoteControl {




  // åŒæ­¥å…¨å±€è¿æ¥çŠ¶æ€ï¼ˆå’ŒCameraPageä¸€æ ·çš„å“åº”å¼å˜é‡ï¼‰
  @State currentState: ConnectionStateResult = { state: false, message: 'æœªè¿æ¥ç›¸æœºï¼' };
  @State previewPixelMap: PixelMap | null = null; // é¢„è§ˆå¸§
  @State previewRunning: boolean = false; // é¢„è§ˆè¿è¡ŒçŠ¶æ€
  @State previewImage: string = '';
  @State photoList: nativeCamera.PhotoPathInfo[] = [];
  @State currentPreviewInterval: number = 0;
  @State statusMessage: string = 'è¯·è¿æ¥ç›¸æœº';

  // å‚æ•°çŠ¶æ€ï¼ˆä¸å¼¹çª—ç»‘å®šéƒ¨åˆ†æœªæ”¹åŠ¨ï¼‰
  @State ISOValue: string = "NA";
  @State apertureValue: string = 'NA';
  @State shutterValue: string = "NA";
  @State paramList: ParamOption[] = [];
  @State exposureCompensationValue: string = "NA";
  @State meterModeValue: string = "NA";
  @State whiteBalanceValue: string = "NA";
  @State focusModeValue: string = "NA";
  @State exposureProgramValue: string = "NA";
  private timerId: number = -1; // é¢„è§ˆå®šæ—¶å™¨ID
  private isProcessingPreview: boolean = false;
  // 1. å£°æ˜å•ä¾‹å˜é‡ï¼ˆç”¨äºå­˜å‚¨é€šè¿‡getInstance()è·å–çš„å®ä¾‹ï¼‰
  private camManager: CamConnectionManager | null = null;


  // å¼¹çª—æ§åˆ¶å™¨
  // ISO å€¼é€‰æ‹©å¼¹çª—
  isoDialogController: CustomDialogController = new CustomDialogController({
    builder: IsoDialog({ selectedISOValue: this.ISOValue }),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  });
  // å…‰åœˆé€‰æ‹©å¼¹çª—
  apertureDialogController:CustomDialogController = new CustomDialogController({
    builder:ApertureDialog({selectedApertureValue:this.apertureValue}),
    customStyle:true,
    alignment:DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // å¿«é—¨é€Ÿåº¦é€‰æ‹©å¼¹çª—
  shutterDialogController: CustomDialogController = new CustomDialogController({
    builder: ShutterSpeedDialog({ SelectedShutterValue: this.shutterValue }),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  });

  // æ›å…‰è¡¥å¿é€‰é¡¹å¼¹çª—
  evDialogController:CustomDialogController = new CustomDialogController({
    builder:ExposureCompensationDialog({selected_EV_Value:this.exposureCompensationValue}),
    customStyle:true,
    alignment:DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // æ›å…‰è¡¥å¿é€‰é¡¹å¼¹çª—
  ExposureMode_DialogController:CustomDialogController = new CustomDialogController({
    builder:ExposureModeDialog({selected_ExposureMode_Value:this.exposureProgramValue}),
    customStyle:true,
    alignment:DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // å¯¹ç„¦æ¨¡å¼é€‰æ‹©å¼¹çª—
  Focus_Mode_DialogController:CustomDialogController = new CustomDialogController({
    builder:FocusModeDialog({selected_Focus_Mode_Value:$focusModeValue}),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // æµ‹å…‰æ¨¡å¼é€‰æ‹©å¼¹çª—
  ExposureMeterMode_DialogController:CustomDialogController = new CustomDialogController({
    builder:ExposureMeterModeDialog({selected_ExposureMeterMode_Value:this.meterModeValue}),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // ç™½å¹³è¡¡é€‰æ‹©å¼¹çª—
  whiteBalance_DialogController:CustomDialogController = new CustomDialogController({
    builder:WhiteBalanceDialog({selectedI_WB_Value:this.whiteBalanceValue}),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })







  aboutToAppear(): void {

    // 2. é€šè¿‡é™æ€æ–¹æ³•è·å–å®ä¾‹ï¼ˆå¤ç”¨EntryAbilityåˆ›å»ºçš„å•ä¾‹ï¼‰
    this.camManager = CamConnectionManager.getInstance();
    if (!this.camManager) {
      console.error("CameraPage è·å–CamConnectionManagerå®ä¾‹å¤±è´¥ï¼");
      return;
    }


    // ğŸ”¥ 1. æ³¨å†Œå…¨å±€çŠ¶æ€ç›‘å¬å™¨ï¼ˆåŒæ­¥è¿æ¥çŠ¶æ€ï¼‰
    this.camManager.addListener(this.handleGlobalStateChange);
    // ğŸ”¥ 2. åˆå§‹åŒ–çŠ¶æ€ï¼šä»å…¨å±€å•ä¾‹è·å–ï¼ˆé¦–æ¬¡åŠ è½½ç”¨ï¼‰
    this.currentState = this.camManager.getCurrentState();
    console.log(`RemoteControl åˆå§‹åŒ–çŠ¶æ€ï¼š${JSON.stringify(this.currentState)}`);


    // ğŸ”¥ 3. å‚æ•°ç®¡ç†åŒæ­¥å…¨å±€è¿æ¥çŠ¶æ€ï¼ˆä¸å†è‡ªå·±è°ƒç”¨updateConnectionStatusï¼‰
    cameraParamManager.updateConnectionStatus(this.currentState.state);




    // æ ¸å¿ƒä¿®æ”¹1ï¼šå‚æ•°åŒæ­¥æ·»åŠ èŠ‚æµï¼ˆ1ç§’æœ€å¤š1æ¬¡ï¼‰ï¼Œé¿å…é¢‘ç¹æ›´æ–°è§¦å‘UIé—ªçƒ
    let lastSyncTime = 0;
    const throttleInterval = 1000; // èŠ‚æµé—´éš”ï¼š1ç§’
    cameraParamManager.addListener(() => {
      const now = Date.now();
      if (now - lastSyncTime > throttleInterval) { // è¶…è¿‡é—´éš”æ‰åŒæ­¥
        this.paramList = cameraParamManager.getParams();
        this.syncParamToUI();
        lastSyncTime = now;
      }
    });

    // åˆå§‹åŒæ­¥å‚æ•°
    this.paramList = cameraParamManager.getParams();
    this.syncParamToUI();




  }

  aboutToDisappear(): void {
    cameraParamManager.removeListener(() => {
      // ä¿ç•™åŸæœ‰é€»è¾‘
    });
  }


  // ğŸ”¥ æ–°å¢ï¼šå…¨å±€çŠ¶æ€å˜åŒ–å›è°ƒï¼ˆåŒæ­¥åˆ°å½“å‰é¡µé¢ï¼‰
  private handleGlobalStateChange = (state: boolean, message: string) => {
    console.log(`RemoteControl å…¨å±€çŠ¶æ€æ›´æ–°ï¼šstate=${state}ï¼Œmessage=${message}`);
    // æ›´æ–°æœ¬åœ°å“åº”å¼å˜é‡ï¼Œè§¦å‘UIåˆ·æ–°
    this.currentState = { state, message };
    // åŒæ­¥å‚æ•°ç®¡ç†çš„è¿æ¥çŠ¶æ€ï¼ˆç¡®ä¿å‚æ•°åˆ·æ–°é€»è¾‘æ­£å¸¸ï¼‰
    cameraParamManager.updateConnectionStatus(state);

    // çŠ¶æ€å˜åŒ–æ—¶çš„è”åŠ¨é€»è¾‘ï¼ˆåŸæœ‰ï¼‰
    if (state) {
      // å·²è¿æ¥ï¼šå¯åŠ¨é¢„è§ˆ
      this.startPreview();
    } else {
      // å·²æ–­å¼€ï¼šåœæ­¢é¢„è§ˆ
      this.stopPreview();
    }
  };






  /**
   * @function åŒæ­¥ç›¸æœºå‚æ•°åˆ°UI
   * */
  // ç®€åŒ– syncParamToUI æ–¹æ³•ï¼Œä»…ä¿ç•™å‚æ•°æå–å’Œç›´æ¥èµ‹å€¼
  private syncParamToUI() {
    // ISOï¼šç›´æ¥ç”¨åŸå§‹å€¼ï¼ˆå¦‚"ISO 320"ï¼‰
    const isoParam = this.paramList.find(p => p.name === 'iso');
    if (isoParam) {
      this.ISOValue = isoParam.currentValue;
    }

    // å…‰åœˆï¼šç›´æ¥ç”¨åŸå§‹å€¼ï¼ˆå¦‚"f/1"ï¼‰ï¼Œç§»é™¤ replace æ ¼å¼åŒ–
    const apertureParam = this.paramList.find(p => p.name === 'aperture');
    if (apertureParam) {
      this.apertureValue = apertureParam.currentValue; // ä¸å†æ›¿æ¢ä¸º"F1"ï¼Œç›´æ¥æ˜¾ç¤º"f/1"
    }

    // å¿«é—¨ï¼šç›´æ¥ç”¨åŸå§‹å€¼ï¼ˆå¦‚"1/125s"ï¼‰ï¼Œç§»é™¤è§£æåŒ¹é…é€»è¾‘
    const shutterParam = this.paramList.find(p => p.name === 'shutter');
    if (shutterParam) {
      this.shutterValue = shutterParam.currentValue; // ä¸å†å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤º
    }

    // æ›å…‰è¡¥å¿ï¼šç›´æ¥ç”¨åŸå§‹å€¼ï¼ˆå¦‚"0.0 æ¡£"ï¼‰ï¼Œç§»é™¤ formatExposureCompensation è½¬æ¢
    const evParam = this.paramList.find(p => p.name === 'exposureCompensation');
    if (evParam) {
      this.exposureCompensationValue = evParam.currentValue;
    }

    // æ›å…‰æ¨¡å¼ï¼šç›´æ¥ç”¨åŸå§‹å€¼ï¼ˆå¦‚"Sï¼ˆå¿«é—¨ä¼˜å…ˆï¼‰"ï¼‰
    const exposureProgramParam = this.paramList.find(p => p.name === 'exposureProgram');
    if (exposureProgramParam) {
      this.exposureProgramValue = exposureProgramParam.currentValue;
    }

    // å¯¹ç„¦æ¨¡å¼ï¼šç›´æ¥ç”¨åŸå§‹å€¼ï¼ˆå¦‚"è¿ç»­è‡ªåŠ¨å¯¹ç„¦ï¼ˆAF-Cï¼‰"ï¼‰
    const focusModeParam = this.paramList.find(p => p.name === 'focusMode');
    if (focusModeParam) {
      this.focusModeValue = focusModeParam.currentValue; // ç§»é™¤æ­£åˆ™æå–é€»è¾‘
    }

    // æµ‹å…‰æ¨¡å¼ï¼šç›´æ¥ç”¨åŸå§‹å€¼ï¼ˆå¦‚"ç‚¹æµ‹å…‰"ï¼‰
    const meterModeParam = this.paramList.find(p => p.name === 'exposureMeterMode');
    if (meterModeParam) {
      this.meterModeValue = meterModeParam.currentValue;
    }

    // ç™½å¹³è¡¡ï¼šç›´æ¥ç”¨åŸå§‹å€¼ï¼ˆå¦‚"è‡ªåŠ¨"ï¼‰
    const wbParam = this.paramList.find(p => p.name === 'whiteBalance');
    if (wbParam) {
      this.whiteBalanceValue = wbParam.currentValue;
    }
  }





  /**
   * @function æ‰‹åŠ¨è¿æ¥ç›¸æœº
   * */
  manualConnect() {
    if (!this.currentState.state) { // æœªè¿æ¥æ—¶æ‰è°ƒç”¨
      this.statusMessage = 'æ­£åœ¨è¿æ¥ç›¸æœº...';
      if (this.camManager) {
        this.camManager.connectCamera().then((success) => {
          // è¿æ¥ç»“æœç”±å…¨å±€çŠ¶æ€å›è°ƒå¤„ç†ï¼Œè¿™é‡Œæ— éœ€é¢å¤–æ›´æ–°
          if (!success) {
            this.statusMessage = 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥WiFi';
          }
        });
      }
      }

  }




  /**
   * @function ï¼ˆä»…ä¼˜åŒ–å®šæ—¶å™¨ç¨³å®šæ€§ï¼Œæœªæ”¹æ ¸å¿ƒé€»è¾‘ï¼‰
   */
  startPreview() {
    if (this.previewRunning || !this.currentState.state) {
      return;
    }
    this.previewRunning = true;
    this.isProcessingPreview = false;

    const updateFrame = () => {
      if (!this.previewRunning) {
        this.timerId = -1;
        return;
      }

      if (this.isProcessingPreview) {
        this.timerId = setTimeout(updateFrame, 10);
        return;
      }

      this.updatePreview().then(() => {
        // ä¿æŒ15FPSç›®æ ‡é—´éš”
        this.timerId = setTimeout(updateFrame, 67);
      }).catch(() => {
        this.timerId = setTimeout(updateFrame, 67);
      });
    };

    this.timerId = setTimeout(updateFrame, 0);
    console.log('é¢„è§ˆå·²å¯åŠ¨ï¼ˆç›®æ ‡15FPSï¼‰');
  }


  /**
   * @function åœæ­¢é¢„è§ˆ
   * */
  stopPreview() {
    // å®Œå…¨ä¿ç•™åŸæœ‰é€»è¾‘
    if (!this.previewRunning) {
      return;
    }
    this.previewRunning = false;
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
    if (this.previewPixelMap) {
      this.previewPixelMap.release().catch((e: Error) => {
        console.error('åœæ­¢é¢„è§ˆæ—¶é‡Šæ”¾èµ„æºå¤±è´¥:', e);
      });
      this.previewPixelMap = null;
    }
    this.isProcessingPreview = false;
    console.log('é¢„è§ˆå·²åœæ­¢');
  }


  /**
   * æ ¸å¿ƒä¿®æ”¹2ï¼šé¢„è§ˆå¸§æ›´æ–°é€»è¾‘ä¼˜åŒ–
   * 1. å…ˆåˆ›å»ºæ–°å¸§å†é‡Šæ”¾æ—§å¸§ï¼Œé¿å…ç©ºç™½æœŸ
   * 2. å‡å°‘é¢„è§ˆå¸§æ›´æ–°å¯¹UIçš„å†²å‡»
   */
  async updatePreview() {
    const startTime = Date.now();
    this.isProcessingPreview = true;
    try {
      if (!nativeCamera.IsCameraConnected()) {
        console.warn('ç›¸æœºå·²æ–­å¼€è¿æ¥ï¼Œåœæ­¢é¢„è§ˆ');
        this.stopPreview();
        return;
      }

      // è·å–é¢„è§ˆæ•°æ®ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
      const arrayBuffer: ArrayBuffer = nativeCamera.GetPreview();
      if (!arrayBuffer || !(arrayBuffer instanceof ArrayBuffer)) {
        console.error('GetPreviewè¿”å›æ— æ•ˆçš„ArrayBuffer');
        return;
      }
      const buffer = new Uint8Array(arrayBuffer);
      if (buffer.length === 0) {
        console.warn('æ— æ•ˆçš„é¢„è§ˆæ•°æ®ï¼Œé•¿åº¦ä¸º0');
        return;
      }

      // æ ¸å¿ƒä¼˜åŒ–ï¼šå…ˆåˆ›å»ºæ–°çš„PixelMapï¼Œå†å¤„ç†æ—§å¸§
      const srcOps: image.SourceOptions = {
        sourceDensity: 0,
        //format: image.Format.JPEG // æ˜ç¡®æ ¼å¼åŠ é€Ÿè§£ç ï¼ˆæ–°å¢ï¼‰
      };
      const imgSrc: image.ImageSource = image.createImageSource(
        buffer.buffer as ArrayBuffer,
        srcOps
      );
      if (!imgSrc) {
        console.error('åˆ›å»ºImageSourceå¤±è´¥');
        return;
      }

      // 1. å…ˆåˆ›å»ºæ–°å¸§ï¼ˆä¸´æ—¶å˜é‡å­˜å‚¨ï¼‰
      const newPixelMap: image.PixelMap = await imgSrc.createPixelMap();
      // 2. ä¿å­˜æ—§å¸§å¼•ç”¨
      const oldPixelMap = this.previewPixelMap;
      // 3. ç›´æ¥æ›´æ–°é¢„è§ˆå¸§ï¼ˆæ— ç©ºç™½æœŸï¼‰
      this.previewPixelMap = newPixelMap;
      // 4. å»¶è¿Ÿé‡Šæ”¾æ—§å¸§ï¼ˆç¡®ä¿æ–°å¸§å·²æ¸²æŸ“ï¼‰
      if (oldPixelMap) {
        setTimeout(() => {
          oldPixelMap.release().catch((e:Error) => console.error('é‡Šæ”¾æ—§å¸§å¤±è´¥:', e));
        }, 100); // å»¶è¿Ÿ100msé‡Šæ”¾ï¼Œé¿å…æ–°å¸§æœªæ¸²æŸ“å®Œæˆ
      }

      const frameTime = Date.now() - startTime;
      console.log(`å•å¸§å¤„ç†è€—æ—¶ï¼š${frameTime}msï¼Œç›®æ ‡67ms`);

    } catch (e) {
      console.error('é¢„è§ˆå¤„ç†å¼‚å¸¸:', e);
      this.stopPreview();
      this.statusMessage = 'é¢„è§ˆå¼‚å¸¸: ' + (e instanceof Error ? e.message : String(e));
    } finally {
      this.isProcessingPreview = false;
    }
  }




  getCameraInfo() {
    // å®Œå…¨ä¿ç•™åŸæœ‰é€»è¾‘
    try {
      const camInfo = nativeCamera.GetCameraStatus();
      console.log("ç›¸æœºè¿æ¥çŠ¶æ€ï¼š", camInfo.isSuccess);
      console.log("ç”µé‡ï¼š", camInfo.batteryLevel);
      console.log("å½“å‰å…‰åœˆï¼š", camInfo.aperture);
      console.log("å½“å‰å¿«é—¨ï¼š", camInfo.shutter);
      console.log("å½“å‰ISOï¼š", camInfo.iso);
      console.log("æ›å…‰è¡¥å¿ï¼š", camInfo.exposureCompensation + "EV");
      console.log("ç™½å¹³è¡¡ï¼š", camInfo.whiteBalance);
      console.log("æ‹æ‘„æ¨¡å¼ï¼š", camInfo.captureMode);
      console.log("å‰©ä½™å¯æ‹å¼ æ•°ï¼š", camInfo.remainingPictures);
      console.log("æ›å…‰æ¨¡å¼", camInfo.exposureProgram);
      console.log(`å¯¹ç„¦æ¨¡å¼ï¼š${camInfo.focusMode}`);
      console.log(`æµ‹å…‰æ¨¡å¼ï¼š${camInfo.exposureMeterMode}`);
    } catch (e) {
      console.error("è·å–ç›¸æœºä¿¡æ¯å¤±è´¥ï¼š", e);
    }
  }

  parseShutterToSeconds(shutterStr: string): number | null {
    // å®Œå…¨ä¿ç•™åŸæœ‰é€»è¾‘
    const str = shutterStr.replace(/s$/i, '').trim();
    if (str.includes('/')) {
      const parts = str.split('/').map(Number);
      const numerator = parts[0];
      const denominator = parts[1];
      if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
        return numerator / denominator;
      }
    }
    const num = parseFloat(str);
    return isNaN(num) ? null : num;
  }





  /**
   * @description æ„å»ºç›¸æœºå‚æ•°æ§åˆ¶æŒ‰é’®çš„UIç»„ä»¶
   * ç”¨äºç»Ÿä¸€æ¸²æŸ“ç›¸æœºå„é¡¹å‚æ•°ï¼ˆå¦‚ISOã€å…‰åœˆã€å¿«é—¨ç­‰ï¼‰çš„æ§åˆ¶æŒ‰é’®ï¼ŒåŒ…å«å‚æ•°æ ‡ç­¾å’Œå½“å‰å€¼å±•ç¤º
   * @param {string} label - å‚æ•°æ ‡ç­¾æ–‡æœ¬ï¼ˆå¦‚"ISO"ã€"å…‰åœˆ"ï¼Œç”¨äºæ ‡è¯†å‚æ•°ç±»å‹ï¼‰
   * @param {string} value - å‚æ•°å½“å‰å€¼ï¼ˆå¦‚"100"ã€"F2.8"ï¼Œå±•ç¤ºå½“å‰å‚æ•°çš„è®¾å®šå€¼ï¼‰
   * @param {() => void} onClick - ç‚¹å‡»æŒ‰é’®æ—¶çš„å›è°ƒå‡½æ•°ï¼ˆé€šå¸¸ç”¨äºæ‰“å¼€å¯¹åº”å‚æ•°çš„è®¾ç½®å¼¹çª—ï¼‰
   * @returns åŒ…å«æ ‡ç­¾æ–‡æœ¬å’Œå‚æ•°å€¼æŒ‰é’®çš„Columnå¸ƒå±€ç»„ä»¶ï¼Œç»Ÿä¸€å‚æ•°æ§åˆ¶æŒ‰é’®çš„æ ·å¼å’Œäº¤äº’é€»è¾‘
   */
  @Builder
  private buildParamButton(label: string, value: string, onClick: () => void) {
    Column({ space: 4 }) {
      Text(label)
        .fontSize(12)
        .fontColor('#666') // æµ…è‰²æ ‡ç­¾åŒºåˆ†ä¸»æ¬¡
        .width('100%')
        .textAlign(TextAlign.Center)

      Button(value)
        .fontSize(6)
        .height(36)
        .width('100%') // è‡ªé€‚åº”ç½‘æ ¼å®½åº¦
      //  .backgroundColor('#f5f5f5')
        .fontColor('#333')
        .borderRadius(6)
        .onClick(onClick)
    }
    .padding({ left: 4, right: 4 })
  }







  // æ„å»ºUIï¼ˆå®Œå…¨ä¿ç•™åŸæœ‰ç»“æ„ï¼Œæœªæ”¹åŠ¨ï¼‰
  build() {
    NavDestination() {
      Column() {

        // é¡¶éƒ¨æ§åˆ¶åŒºåŸŸ
        Column({ space: 10 }) {
          Row({ space: 10 }) {
            Button('é…ç½®æ‰“å°')
              .onClick(() => {
                this.getCameraInfo()
              })


            Button('æ‰‹åŠ¨è¿æ¥ç›¸æœº')
              .onClick(() => {
                this.manualConnect();
              })
              .enabled(!this.currentState.state)

          }


          // è¿æ¥çŠ¶æ€æŒ‡ç¤º
          Row({ space: 10 }) {
            Text(this.currentState.message)
              .fontSize(18)

            Circle()
              .borderRadius(12)
              .width(24)
              .height(24)
              .fill(this.currentState.state ? '#00C853' : '#F44336')
              .shadow({
                radius: 8,
                color: this.currentState.state ? 'rgba(0, 200, 83, 0.6)' : 'rgba(244, 67, 54, 0.6)',
                offsetX: 0,
                offsetY: 0
              })
              .animation({ duration: 300 });
          }
        }
        .margin({ top: 10 })



        /**
         * @description é¢„è§ˆç”»é¢æ˜¾ç¤ºåŒºåŸŸ
         * */
        Column() {
          if (this.previewPixelMap) {
            Image(this.previewPixelMap)
              .width('100%')
              .height(250)
              .objectFit(ImageFit.Contain)
          } else if (!this.previewRunning) {
            Text('æœªå¯åŠ¨é¢„è§ˆ')
              .width('100%')
              .height(250)
              .backgroundColor(Color.Black)
              .fontColor(Color.White)
              .fontSize(16)
              .textAlign(TextAlign.Center)
          }
        }
        .margin({ top: 10 })




        // å‚æ•°æ§åˆ¶æ 
        Column() {
          // ç¬¬ä¸€ç»„ï¼šæ›å…‰æ ¸å¿ƒå‚æ•°ï¼ˆISOã€å…‰åœˆã€å¿«é—¨ã€æ›å…‰è¡¥å¿ï¼‰
          Grid(){
            GridItem(){this.buildParamButton('ISO',this.ISOValue,()=>{this.isoDialogController.open()})}
            GridItem(){ this.buildParamButton('å…‰åœˆ', this.apertureValue, () => {this.apertureDialogController.open()}) }
            GridItem() { this.buildParamButton('å¿«é—¨', this.shutterValue, () =>{this.shutterDialogController.open()} ) }
            GridItem() { this.buildParamButton('æ›å…‰è¡¥å¿', this.exposureCompensationValue, () => { this.evDialogController.open() }) }
          }
          .columnsTemplate('1fr 1fr 1fr 1fr') // 4åˆ—ç½‘æ ¼
          .columnsGap(8)
          .padding(10)
          .height(80)  // å›ºå®šç¬¬ä¸€ç»„ç½‘æ ¼é«˜åº¦ï¼ˆæŒ‰é’®36 + é—´è· + å†…è¾¹è·ï¼‰
          .backgroundColor('#f9f9f9')  // å¯é€‰ï¼šæ·»åŠ èƒŒæ™¯è‰²åŒºåˆ†åŒºåŸŸ
          .borderRadius(8)

          // ç¬¬äºŒç»„ï¼šæ‹æ‘„æ¨¡å¼å‚æ•°ï¼ˆæ›å…‰æ¨¡å¼ã€å¯¹ç„¦æ¨¡å¼ï¼‰
          Grid() {
            GridItem() { this.buildParamButton('æ›å…‰æ¨¡å¼', this.exposureProgramValue, () =>{this.ExposureMode_DialogController.open() } ) }
            GridItem() { this.buildParamButton('å¯¹ç„¦æ¨¡å¼', this.focusModeValue, () => {this.Focus_Mode_DialogController.open() }) }
            GridItem() { this.buildParamButton('æµ‹å…‰æ¨¡å¼', this.meterModeValue, () => {this.ExposureMeterMode_DialogController.open() }) }
            GridItem() { this.buildParamButton('ç™½å¹³è¡¡', this.whiteBalanceValue, () => {this.whiteBalance_DialogController.open() }) }
          }
          .columnsTemplate('1fr 1fr 1fr 1fr')
          .columnsGap(8)
          .padding(10)
          .height(80)  // å›ºå®šç¬¬äºŒç»„ç½‘æ ¼é«˜åº¦
          .backgroundColor('#f9f9f9')
          .borderRadius(8)
          .margin({ top: 8 })  // ä¸¤ç»„ä¹‹é—´æ·»åŠ é—´è·


        }
        .width("100%")
        .padding({ left: 10, right: 10 })  // å·¦å³ç•™è¾¹ï¼Œé¿å…å†…å®¹è´´è¾¹




        /**
         * @function é¢„è§ˆæŒ‰é’®åŒºåŸŸ
         * */
        Row({ space: 10 }) {
          Button('å¯åŠ¨é¢„è§ˆ')
            .enabled(!this.previewRunning)
            .onClick(() => this.startPreview())

          Button('åœæ­¢é¢„è§ˆ')
            .enabled(this.previewRunning)
            .onClick(() => this.stopPreview())
        }
        .margin({ top: 10 })


        /**
         *@function æ‹ç…§æŒ‰é’®åŒºåŸŸ
         * */
        Row({ space: 10 }) {
          Button('å›¾åº“')
          Button('æ‹ç…§')
            .onClick(() => {
              //this.takeAndDownloadKnown()
            })
        }
        .margin({ top: 20 })
      }
      .width("100%")
      .height("100%")
    }
    .title('é¥æ§æ‹ç…§')
  }
}