//RemoteControl.ets
import nativeCamera from 'libentry.so'
import { IsoDialog } from 'ets/component/CameraControlDialog/IsoDialog'
import { ShutterSpeedDialog } from 'ets/component/CameraControlDialog/ShutterSpeedDialog'
import { image } from '@kit.ImageKit';
import { fileIo } from '@kit.CoreFileKit'
import { common } from '@kit.AbilityKit';
import getCamIpAndName from '../../utils/GetCameraIpAndName'
import { cameraParamManager, ParamOption } from '../../utils/CameraParamManager'
import { ApertureDialog } from '../../component/CameraControlDialog/ApertureDialog';
import { FocusModeDialog } from '../../component/CameraControlDialog/FocusModeDialog';
import { ExposureCompensationDialog } from '../../component/CameraControlDialog/ExposureCompensationDialog';
import { WhiteBalanceDialog } from '../../component/CameraControlDialog/WhiteBalanceDialog';
import { ExposureMeterModeDialog } from '../../component/CameraControlDialog/ExposureMeterModeDialog';
import { ExposureModeDialog } from '../../component/CameraControlDialog/ExposureModeDialog';
import { camConnectionManager, ConnectionStateResult } from '../../utils/CamConnectManager';


const scanner = new getCamIpAndName();
let cameraIp: string;


const evMap: Record<string, string> = {
  "-2": "-2",
  "-1.666": "-1 2/3",
  "-1.333": "-1 1/3",
  "-1": "-1",
  "-0.666": "-2/3",
  "-0.333": "-1/3",
  "0": "0",
  "0.333": "+1/3",
  "0.666": "+2/3",
  "1": "+1",
  "1.333": "+1 1/3",
  "1.666": "+1 2/3",
  "2": "+2"
};


interface ShutterOptionSec {
  original: string;
  sec: number | null;
}


@Builder
export function RemoteControlBuilder() {
  RemoteControl();
}


@Component
export struct RemoteControl {




  // ÂêåÊ≠•ÂÖ®Â±ÄËøûÊé•Áä∂ÊÄÅÔºàÂíåCameraPage‰∏ÄÊ†∑ÁöÑÂìçÂ∫îÂºèÂèòÈáèÔºâ
  @State currentState: ConnectionStateResult = { state: false, message: 'Êú™ËøûÊé•Áõ∏Êú∫ÔºÅ' };
  @State previewPixelMap: PixelMap | null = null; // È¢ÑËßàÂ∏ß
  @State previewRunning: boolean = false; // È¢ÑËßàËøêË°åÁä∂ÊÄÅ
  @State previewImage: string = '';
  @State photoList: nativeCamera.PhotoPathInfo[] = [];
  @State currentPreviewInterval: number = 0;
  @State statusMessage: string = 'ËØ∑ËøûÊé•Áõ∏Êú∫';

  // ÂèÇÊï∞Áä∂ÊÄÅÔºà‰∏éÂºπÁ™óÁªëÂÆöÈÉ®ÂàÜÊú™ÊîπÂä®Ôºâ
  @State ISOValue: string = "NA";
  @State apertureValue: string = 'NA';
  @State shutterValue: string = "NA";
  @State paramList: ParamOption[] = [];
  @State exposureCompensationValue: string = "NA";
  @State meterModeValue: string = "NA";
  @State whiteBalanceValue: string = "NA";
  @State focusModeValue: string = "NA";
  @State exposureProgramValue: string = "NA";

  private nativeLibDir: string = '';
  private timerId: number = -1; // È¢ÑËßàÂÆöÊó∂Âô®ID
  private isProcessingPreview: boolean = false;

  // ÂºπÁ™óÊéßÂà∂Âô®
  // ISO ÂÄºÈÄâÊã©ÂºπÁ™ó
  isoDialogController: CustomDialogController = new CustomDialogController({
    builder: IsoDialog({ selectedISOValue: this.ISOValue }),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  });
  // ÂÖâÂúàÈÄâÊã©ÂºπÁ™ó
  apertureDialogController:CustomDialogController = new CustomDialogController({
    builder:ApertureDialog({selectedApertureValue:this.apertureValue}),
    customStyle:true,
    alignment:DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // Âø´Èó®ÈÄüÂ∫¶ÈÄâÊã©ÂºπÁ™ó
  shutterDialogController: CustomDialogController = new CustomDialogController({
    builder: ShutterSpeedDialog({ SelectedShutterValue: this.shutterValue }),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  });

  // ÊõùÂÖâË°•ÂÅøÈÄâÈ°πÂºπÁ™ó
  evDialogController:CustomDialogController = new CustomDialogController({
    builder:ExposureCompensationDialog({selected_EV_Value:this.exposureCompensationValue}),
    customStyle:true,
    alignment:DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // ÊõùÂÖâË°•ÂÅøÈÄâÈ°πÂºπÁ™ó
  ExposureMode_DialogController:CustomDialogController = new CustomDialogController({
    builder:ExposureModeDialog({selected_ExposureMode_Value:this.exposureProgramValue}),
    customStyle:true,
    alignment:DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // ÂØπÁÑ¶Ê®°ÂºèÈÄâÊã©ÂºπÁ™ó
  Focus_Mode_DialogController:CustomDialogController = new CustomDialogController({
    builder:FocusModeDialog({selected_Focus_Mode_Value:$focusModeValue}),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // ÊµãÂÖâÊ®°ÂºèÈÄâÊã©ÂºπÁ™ó
  ExposureMeterMode_DialogController:CustomDialogController = new CustomDialogController({
    builder:ExposureMeterModeDialog({selected_ExposureMeterMode_Value:this.meterModeValue}),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })

  // ÁôΩÂπ≥Ë°°ÈÄâÊã©ÂºπÁ™ó
  whiteBalance_DialogController:CustomDialogController = new CustomDialogController({
    builder:WhiteBalanceDialog({selectedI_WB_Value:this.whiteBalanceValue}),
    customStyle: true,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: 0 }
  })







  aboutToAppear(): void {

    // üî• 1. Ê≥®ÂÜåÂÖ®Â±ÄÁä∂ÊÄÅÁõëÂê¨Âô®ÔºàÂêåÊ≠•ËøûÊé•Áä∂ÊÄÅÔºâ
    camConnectionManager.addListener(this.handleGlobalStateChange);
    // üî• 2. ÂàùÂßãÂåñÁä∂ÊÄÅÔºö‰ªéÂÖ®Â±ÄÂçï‰æãËé∑ÂèñÔºàÈ¶ñÊ¨°Âä†ËΩΩÁî®Ôºâ
    this.currentState = camConnectionManager.getCurrentState();
    console.log(`RemoteControl ÂàùÂßãÂåñÁä∂ÊÄÅÔºö${JSON.stringify(this.currentState)}`);


    // üî• 3. ÂèÇÊï∞ÁÆ°ÁêÜÂêåÊ≠•ÂÖ®Â±ÄËøûÊé•Áä∂ÊÄÅÔºà‰∏çÂÜçËá™Â∑±Ë∞ÉÁî®updateConnectionStatusÔºâ
    cameraParamManager.updateConnectionStatus(this.currentState.state);




    // Ê†∏ÂøÉ‰øÆÊîπ1ÔºöÂèÇÊï∞ÂêåÊ≠•Ê∑ªÂä†ËäÇÊµÅÔºà1ÁßíÊúÄÂ§ö1Ê¨°ÔºâÔºåÈÅøÂÖçÈ¢ëÁπÅÊõ¥Êñ∞Ëß¶ÂèëUIÈó™ÁÉÅ
    let lastSyncTime = 0;
    const throttleInterval = 1000; // ËäÇÊµÅÈó¥ÈöîÔºö1Áßí
    cameraParamManager.addListener(() => {
      const now = Date.now();
      if (now - lastSyncTime > throttleInterval) { // Ë∂ÖËøáÈó¥ÈöîÊâçÂêåÊ≠•
        this.paramList = cameraParamManager.getParams();
        this.syncParamToUI();
        lastSyncTime = now;
      }
    });

    // ÂàùÂßãÂêåÊ≠•ÂèÇÊï∞
    this.paramList = cameraParamManager.getParams();
    this.syncParamToUI();




  }

  aboutToDisappear(): void {
    cameraParamManager.removeListener(() => {
      // ‰øùÁïôÂéüÊúâÈÄªËæë
    });
  }


  // üî• Êñ∞Â¢ûÔºöÂÖ®Â±ÄÁä∂ÊÄÅÂèòÂåñÂõûË∞ÉÔºàÂêåÊ≠•Âà∞ÂΩìÂâçÈ°µÈù¢Ôºâ
  private handleGlobalStateChange = (state: boolean, message: string) => {
    console.log(`RemoteControl ÂÖ®Â±ÄÁä∂ÊÄÅÊõ¥Êñ∞Ôºöstate=${state}Ôºåmessage=${message}`);
    // Êõ¥Êñ∞Êú¨Âú∞ÂìçÂ∫îÂºèÂèòÈáèÔºåËß¶ÂèëUIÂà∑Êñ∞
    this.currentState = { state, message };
    // ÂêåÊ≠•ÂèÇÊï∞ÁÆ°ÁêÜÁöÑËøûÊé•Áä∂ÊÄÅÔºàÁ°Æ‰øùÂèÇÊï∞Âà∑Êñ∞ÈÄªËæëÊ≠£Â∏∏Ôºâ
    cameraParamManager.updateConnectionStatus(state);

    // Áä∂ÊÄÅÂèòÂåñÊó∂ÁöÑËÅîÂä®ÈÄªËæëÔºàÂéüÊúâÔºâ
    if (state) {
      // Â∑≤ËøûÊé•ÔºöÂêØÂä®È¢ÑËßà
      this.startPreview();
    } else {
      // Â∑≤Êñ≠ÂºÄÔºöÂÅúÊ≠¢È¢ÑËßà
      this.stopPreview();
    }
  };






  /**
   * @function ÂêåÊ≠•Áõ∏Êú∫ÂèÇÊï∞Âà∞UI
   * */
  // ÁÆÄÂåñ syncParamToUI ÊñπÊ≥ïÔºå‰ªÖ‰øùÁïôÂèÇÊï∞ÊèêÂèñÂíåÁõ¥Êé•ËµãÂÄº
  private syncParamToUI() {
    // ISOÔºöÁõ¥Êé•Áî®ÂéüÂßãÂÄºÔºàÂ¶Ç"ISO 320"Ôºâ
    const isoParam = this.paramList.find(p => p.name === 'iso');
    if (isoParam) {
      this.ISOValue = isoParam.currentValue;
    }

    // ÂÖâÂúàÔºöÁõ¥Êé•Áî®ÂéüÂßãÂÄºÔºàÂ¶Ç"f/1"ÔºâÔºåÁßªÈô§ replace Ê†ºÂºèÂåñ
    const apertureParam = this.paramList.find(p => p.name === 'aperture');
    if (apertureParam) {
      this.apertureValue = apertureParam.currentValue; // ‰∏çÂÜçÊõøÊç¢‰∏∫"F1"ÔºåÁõ¥Êé•ÊòæÁ§∫"f/1"
    }

    // Âø´Èó®ÔºöÁõ¥Êé•Áî®ÂéüÂßãÂÄºÔºàÂ¶Ç"1/125s"ÔºâÔºåÁßªÈô§Ëß£ÊûêÂåπÈÖçÈÄªËæë
    const shutterParam = this.paramList.find(p => p.name === 'shutter');
    if (shutterParam) {
      this.shutterValue = shutterParam.currentValue; // ‰∏çÂÜçÂ§ÑÁêÜÔºåÁõ¥Êé•ÊòæÁ§∫
    }

    // ÊõùÂÖâË°•ÂÅøÔºöÁõ¥Êé•Áî®ÂéüÂßãÂÄºÔºàÂ¶Ç"0.0 Ê°£"ÔºâÔºåÁßªÈô§ formatExposureCompensation ËΩ¨Êç¢
    const evParam = this.paramList.find(p => p.name === 'exposureCompensation');
    if (evParam) {
      this.exposureCompensationValue = evParam.currentValue;
    }

    // ÊõùÂÖâÊ®°ÂºèÔºöÁõ¥Êé•Áî®ÂéüÂßãÂÄºÔºàÂ¶Ç"SÔºàÂø´Èó®‰ºòÂÖàÔºâ"Ôºâ
    const exposureProgramParam = this.paramList.find(p => p.name === 'exposureProgram');
    if (exposureProgramParam) {
      this.exposureProgramValue = exposureProgramParam.currentValue;
    }

    // ÂØπÁÑ¶Ê®°ÂºèÔºöÁõ¥Êé•Áî®ÂéüÂßãÂÄºÔºàÂ¶Ç"ËøûÁª≠Ëá™Âä®ÂØπÁÑ¶ÔºàAF-CÔºâ"Ôºâ
    const focusModeParam = this.paramList.find(p => p.name === 'focusMode');
    if (focusModeParam) {
      this.focusModeValue = focusModeParam.currentValue; // ÁßªÈô§Ê≠£ÂàôÊèêÂèñÈÄªËæë
    }

    // ÊµãÂÖâÊ®°ÂºèÔºöÁõ¥Êé•Áî®ÂéüÂßãÂÄºÔºàÂ¶Ç"ÁÇπÊµãÂÖâ"Ôºâ
    const meterModeParam = this.paramList.find(p => p.name === 'exposureMeterMode');
    if (meterModeParam) {
      this.meterModeValue = meterModeParam.currentValue;
    }

    // ÁôΩÂπ≥Ë°°ÔºöÁõ¥Êé•Áî®ÂéüÂßãÂÄºÔºàÂ¶Ç"Ëá™Âä®"Ôºâ
    const wbParam = this.paramList.find(p => p.name === 'whiteBalance');
    if (wbParam) {
      this.whiteBalanceValue = wbParam.currentValue;
    }
  }





  /**
   * @function ÊâãÂä®ËøûÊé•Áõ∏Êú∫
   * */
  manualConnect() {
    if (!this.currentState.state) { // Êú™ËøûÊé•Êó∂ÊâçË∞ÉÁî®
      this.statusMessage = 'Ê≠£Âú®ËøûÊé•Áõ∏Êú∫...';
      camConnectionManager.connectCamera().then((success) => {
        // ËøûÊé•ÁªìÊûúÁî±ÂÖ®Â±ÄÁä∂ÊÄÅÂõûË∞ÉÂ§ÑÁêÜÔºåËøôÈáåÊó†ÈúÄÈ¢ùÂ§ñÊõ¥Êñ∞
        if (!success) {
          this.statusMessage = 'ËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•WiFi';
        }
      });
    }
  }




  /**
   * @function Ôºà‰ªÖ‰ºòÂåñÂÆöÊó∂Âô®Á®≥ÂÆöÊÄßÔºåÊú™ÊîπÊ†∏ÂøÉÈÄªËæëÔºâ
   */
  startPreview() {
    if (this.previewRunning || !this.currentState.state) {
      return;
    }
    this.previewRunning = true;
    this.isProcessingPreview = false;

    const updateFrame = () => {
      if (!this.previewRunning) {
        this.timerId = -1;
        return;
      }

      if (this.isProcessingPreview) {
        this.timerId = setTimeout(updateFrame, 10);
        return;
      }

      this.updatePreview().then(() => {
        // ‰øùÊåÅ15FPSÁõÆÊ†áÈó¥Èöî
        this.timerId = setTimeout(updateFrame, 67);
      }).catch(() => {
        this.timerId = setTimeout(updateFrame, 67);
      });
    };

    this.timerId = setTimeout(updateFrame, 0);
    console.log('È¢ÑËßàÂ∑≤ÂêØÂä®ÔºàÁõÆÊ†á15FPSÔºâ');
  }


  /**
   * @function ÂÅúÊ≠¢È¢ÑËßà
   * */
  stopPreview() {
    // ÂÆåÂÖ®‰øùÁïôÂéüÊúâÈÄªËæë
    if (!this.previewRunning) {
      return;
    }
    this.previewRunning = false;
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
    if (this.previewPixelMap) {
      this.previewPixelMap.release().catch((e: Error) => {
        console.error('ÂÅúÊ≠¢È¢ÑËßàÊó∂ÈáäÊîæËµÑÊ∫êÂ§±Ë¥•:', e);
      });
      this.previewPixelMap = null;
    }
    this.isProcessingPreview = false;
    console.log('È¢ÑËßàÂ∑≤ÂÅúÊ≠¢');
  }


  /**
   * Ê†∏ÂøÉ‰øÆÊîπ2ÔºöÈ¢ÑËßàÂ∏ßÊõ¥Êñ∞ÈÄªËæë‰ºòÂåñ
   * 1. ÂÖàÂàõÂª∫Êñ∞Â∏ßÂÜçÈáäÊîæÊóßÂ∏ßÔºåÈÅøÂÖçÁ©∫ÁôΩÊúü
   * 2. ÂáèÂ∞ëÈ¢ÑËßàÂ∏ßÊõ¥Êñ∞ÂØπUIÁöÑÂÜ≤Âáª
   */
  async updatePreview() {
    const startTime = Date.now();
    this.isProcessingPreview = true;
    try {
      if (!nativeCamera.IsCameraConnected()) {
        console.warn('Áõ∏Êú∫Â∑≤Êñ≠ÂºÄËøûÊé•ÔºåÂÅúÊ≠¢È¢ÑËßà');
        this.stopPreview();
        return;
      }

      // Ëé∑ÂèñÈ¢ÑËßàÊï∞ÊçÆÔºà‰øùÁïôÂéüÊúâÈÄªËæëÔºâ
      const arrayBuffer: ArrayBuffer = nativeCamera.GetPreview();
      if (!arrayBuffer || !(arrayBuffer instanceof ArrayBuffer)) {
        console.error('GetPreviewËøîÂõûÊó†ÊïàÁöÑArrayBuffer');
        return;
      }
      const buffer = new Uint8Array(arrayBuffer);
      if (buffer.length === 0) {
        console.warn('Êó†ÊïàÁöÑÈ¢ÑËßàÊï∞ÊçÆÔºåÈïøÂ∫¶‰∏∫0');
        return;
      }

      // Ê†∏ÂøÉ‰ºòÂåñÔºöÂÖàÂàõÂª∫Êñ∞ÁöÑPixelMapÔºåÂÜçÂ§ÑÁêÜÊóßÂ∏ß
      const srcOps: image.SourceOptions = {
        sourceDensity: 0,
        //format: image.Format.JPEG // ÊòéÁ°ÆÊ†ºÂºèÂä†ÈÄüËß£Á†ÅÔºàÊñ∞Â¢ûÔºâ
      };
      const imgSrc: image.ImageSource = image.createImageSource(
        buffer.buffer as ArrayBuffer,
        srcOps
      );
      if (!imgSrc) {
        console.error('ÂàõÂª∫ImageSourceÂ§±Ë¥•');
        return;
      }

      // 1. ÂÖàÂàõÂª∫Êñ∞Â∏ßÔºà‰∏¥Êó∂ÂèòÈáèÂ≠òÂÇ®Ôºâ
      const newPixelMap: image.PixelMap = await imgSrc.createPixelMap();
      // 2. ‰øùÂ≠òÊóßÂ∏ßÂºïÁî®
      const oldPixelMap = this.previewPixelMap;
      // 3. Áõ¥Êé•Êõ¥Êñ∞È¢ÑËßàÂ∏ßÔºàÊó†Á©∫ÁôΩÊúüÔºâ
      this.previewPixelMap = newPixelMap;
      // 4. Âª∂ËøüÈáäÊîæÊóßÂ∏ßÔºàÁ°Æ‰øùÊñ∞Â∏ßÂ∑≤Ê∏≤ÊüìÔºâ
      if (oldPixelMap) {
        setTimeout(() => {
          oldPixelMap.release().catch((e:Error) => console.error('ÈáäÊîæÊóßÂ∏ßÂ§±Ë¥•:', e));
        }, 100); // Âª∂Ëøü100msÈáäÊîæÔºåÈÅøÂÖçÊñ∞Â∏ßÊú™Ê∏≤ÊüìÂÆåÊàê
      }

      const frameTime = Date.now() - startTime;
      console.log(`ÂçïÂ∏ßÂ§ÑÁêÜËÄóÊó∂Ôºö${frameTime}msÔºåÁõÆÊ†á67ms`);

    } catch (e) {
      console.error('È¢ÑËßàÂ§ÑÁêÜÂºÇÂ∏∏:', e);
      this.stopPreview();
      this.statusMessage = 'È¢ÑËßàÂºÇÂ∏∏: ' + (e instanceof Error ? e.message : String(e));
    } finally {
      this.isProcessingPreview = false;
    }
  }


  takeAndDownloadKnown() {
    // ÂÆåÂÖ®‰øùÁïôÂéüÊúâÈÄªËæë
    try {
      const ok = nativeCamera.TakePhoto();
      if (!ok) {
        this.statusMessage = 'ÊãçÁÖßÂ§±Ë¥•';
        return;
      }

      const folder = "DCIM/100CANON";
      const filename = "IMG_0001.JPG";
      const arrBuf: ArrayBuffer = nativeCamera.DownloadPhoto(folder, filename);
      if (!arrBuf) {
        this.statusMessage = '‰∏ãËΩΩÂ§±Ë¥•';
        return;
      }

      const context = getContext(this) as common.UIAbilityContext;
      const savePath = `${context.filesDir}/${filename}`;
      const fdAny = fileIo.openSync(savePath, fileIo.OpenMode.CREATE | fileIo.OpenMode.READ_WRITE);
      const uint8Arr = new Uint8Array(arrBuf);

      if (typeof fdAny === 'number') {
        fileIo.writeSync(fdAny, uint8Arr);
        fileIo.closeSync(fdAny);
      } else {
        fileIo.writeSync(fdAny.fd, uint8Arr);
        fileIo.closeSync(fdAny);
      }

      this.previewImage = savePath;
      this.photoList.push({ folder: savePath, name: filename });
      this.statusMessage = 'ÊãçÁÖßÂπ∂‰øùÂ≠òÊàêÂäü';
    } catch (e) {
      console.error("ÂºÇÂ∏∏: " + JSON.stringify(e));
      this.statusMessage = 'ÊãçÁÖß‰∏ãËΩΩÂºÇÂ∏∏';
    }
  }


  getCameraInfo() {
    // ÂÆåÂÖ®‰øùÁïôÂéüÊúâÈÄªËæë
    try {
      const camInfo = nativeCamera.GetCameraStatus();
      console.log("Áõ∏Êú∫ËøûÊé•Áä∂ÊÄÅÔºö", camInfo.isSuccess);
      console.log("ÁîµÈáèÔºö", camInfo.batteryLevel);
      console.log("ÂΩìÂâçÂÖâÂúàÔºö", camInfo.aperture);
      console.log("ÂΩìÂâçÂø´Èó®Ôºö", camInfo.shutter);
      console.log("ÂΩìÂâçISOÔºö", camInfo.iso);
      console.log("ÊõùÂÖâË°•ÂÅøÔºö", camInfo.exposureCompensation + "EV");
      console.log("ÁôΩÂπ≥Ë°°Ôºö", camInfo.whiteBalance);
      console.log("ÊãçÊëÑÊ®°ÂºèÔºö", camInfo.captureMode);
      console.log("Ââ©‰ΩôÂèØÊãçÂº†Êï∞Ôºö", camInfo.remainingPictures);
      console.log("ÊõùÂÖâÊ®°Âºè", camInfo.exposureProgram);
      console.log(`ÂØπÁÑ¶Ê®°ÂºèÔºö${camInfo.focusMode}`);
      console.log(`ÊµãÂÖâÊ®°ÂºèÔºö${camInfo.exposureMeterMode}`);
    } catch (e) {
      console.error("Ëé∑ÂèñÁõ∏Êú∫‰ø°ÊÅØÂ§±Ë¥•Ôºö", e);
    }
  }


  private formatExposureCompensation(value: string): string {
    // ÂÆåÂÖ®‰øùÁïôÂéüÊúâÈÄªËæë
    const num = parseFloat(value);
    if (isNaN(num)) {
      return 'NA';
    }
    const closestKey = Object.keys(evMap).find(key => {
      return Math.abs(parseFloat(key) - num) < 0.001;
    });
    return closestKey ? `${evMap[parseFloat(closestKey)]}` : `${num}`;
  }


  parseShutterToSeconds(shutterStr: string): number | null {
    // ÂÆåÂÖ®‰øùÁïôÂéüÊúâÈÄªËæë
    const str = shutterStr.replace(/s$/i, '').trim();
    if (str.includes('/')) {
      const parts = str.split('/').map(Number);
      const numerator = parts[0];
      const denominator = parts[1];
      if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
        return numerator / denominator;
      }
    }
    const num = parseFloat(str);
    return isNaN(num) ? null : num;
  }





  /**
   * @description ÊûÑÂª∫Áõ∏Êú∫ÂèÇÊï∞ÊéßÂà∂ÊåâÈíÆÁöÑUIÁªÑ‰ª∂
   * Áî®‰∫éÁªü‰∏ÄÊ∏≤ÊüìÁõ∏Êú∫ÂêÑÈ°πÂèÇÊï∞ÔºàÂ¶ÇISO„ÄÅÂÖâÂúà„ÄÅÂø´Èó®Á≠âÔºâÁöÑÊéßÂà∂ÊåâÈíÆÔºåÂåÖÂê´ÂèÇÊï∞Ê†áÁ≠æÂíåÂΩìÂâçÂÄºÂ±ïÁ§∫
   * @param {string} label - ÂèÇÊï∞Ê†áÁ≠æÊñáÊú¨ÔºàÂ¶Ç"ISO"„ÄÅ"ÂÖâÂúà"ÔºåÁî®‰∫éÊ†áËØÜÂèÇÊï∞Á±ªÂûãÔºâ
   * @param {string} value - ÂèÇÊï∞ÂΩìÂâçÂÄºÔºàÂ¶Ç"100"„ÄÅ"F2.8"ÔºåÂ±ïÁ§∫ÂΩìÂâçÂèÇÊï∞ÁöÑËÆæÂÆöÂÄºÔºâ
   * @param {() => void} onClick - ÁÇπÂáªÊåâÈíÆÊó∂ÁöÑÂõûË∞ÉÂáΩÊï∞ÔºàÈÄöÂ∏∏Áî®‰∫éÊâìÂºÄÂØπÂ∫îÂèÇÊï∞ÁöÑËÆæÁΩÆÂºπÁ™óÔºâ
   * @returns ÂåÖÂê´Ê†áÁ≠æÊñáÊú¨ÂíåÂèÇÊï∞ÂÄºÊåâÈíÆÁöÑColumnÂ∏ÉÂ±ÄÁªÑ‰ª∂ÔºåÁªü‰∏ÄÂèÇÊï∞ÊéßÂà∂ÊåâÈíÆÁöÑÊ†∑ÂºèÂíå‰∫§‰∫íÈÄªËæë
   */
  @Builder
  private buildParamButton(label: string, value: string, onClick: () => void) {
    Column({ space: 4 }) {
      Text(label)
        .fontSize(12)
        .fontColor('#666') // ÊµÖËâ≤Ê†áÁ≠æÂå∫ÂàÜ‰∏ªÊ¨°
        .width('100%')
        .textAlign(TextAlign.Center)

      Button(value)
        .fontSize(6)
        .height(36)
        .width('100%') // Ëá™ÈÄÇÂ∫îÁΩëÊ†ºÂÆΩÂ∫¶
      //  .backgroundColor('#f5f5f5')
        .fontColor('#333')
        .borderRadius(6)
        .onClick(onClick)
    }
    .padding({ left: 4, right: 4 })
  }







  // ÊûÑÂª∫UIÔºàÂÆåÂÖ®‰øùÁïôÂéüÊúâÁªìÊûÑÔºåÊú™ÊîπÂä®Ôºâ
  build() {
    NavDestination() {
      Column() {

        // È°∂ÈÉ®ÊéßÂà∂Âå∫Âüü
        Column({ space: 10 }) {
          Row({ space: 10 }) {
            Button('ÈÖçÁΩÆÊâìÂç∞')
              .onClick(() => {
                this.getCameraInfo()
              })


            Button('ÊâãÂä®ËøûÊé•Áõ∏Êú∫')
              .onClick(() => {
                this.manualConnect();
              })
              .enabled(!this.currentState.state)

          }


          // ËøûÊé•Áä∂ÊÄÅÊåáÁ§∫
          Row({ space: 10 }) {
            Text(this.currentState.message)
              .fontSize(18)

            Circle()
              .borderRadius(12)
              .width(24)
              .height(24)
              .fill(this.currentState.state ? '#00C853' : '#F44336')
              .shadow({
                radius: 8,
                color: this.currentState.state ? 'rgba(0, 200, 83, 0.6)' : 'rgba(244, 67, 54, 0.6)',
                offsetX: 0,
                offsetY: 0
              })
              .animation({ duration: 300 });
          }
        }
        .margin({ top: 10 })



        /**
         * @description È¢ÑËßàÁîªÈù¢ÊòæÁ§∫Âå∫Âüü
         * */
        Column() {
          if (this.previewPixelMap) {
            Image(this.previewPixelMap)
              .width('100%')
              .height(250)
              .objectFit(ImageFit.Contain)
          } else if (!this.previewRunning) {
            Text('Êú™ÂêØÂä®È¢ÑËßà')
              .width('100%')
              .height(250)
              .backgroundColor(Color.Black)
              .fontColor(Color.White)
              .fontSize(16)
              .textAlign(TextAlign.Center)
          }
        }
        .margin({ top: 10 })




        // ÂèÇÊï∞ÊéßÂà∂Ê†è
        Column() {
          // Á¨¨‰∏ÄÁªÑÔºöÊõùÂÖâÊ†∏ÂøÉÂèÇÊï∞ÔºàISO„ÄÅÂÖâÂúà„ÄÅÂø´Èó®„ÄÅÊõùÂÖâË°•ÂÅøÔºâ
          Grid(){
            GridItem(){this.buildParamButton('ISO',this.ISOValue,()=>{this.isoDialogController.open()})}
            GridItem(){ this.buildParamButton('ÂÖâÂúà', this.apertureValue, () => {this.apertureDialogController.open()}) }
            GridItem() { this.buildParamButton('Âø´Èó®', this.shutterValue, () =>{this.shutterDialogController.open()} ) }
            GridItem() { this.buildParamButton('ÊõùÂÖâË°•ÂÅø', this.exposureCompensationValue, () => { this.evDialogController.open() }) }
          }
          .columnsTemplate('1fr 1fr 1fr 1fr') // 4ÂàóÁΩëÊ†º
          .columnsGap(8)
          .padding(10)
          .height(80)  // Âõ∫ÂÆöÁ¨¨‰∏ÄÁªÑÁΩëÊ†ºÈ´òÂ∫¶ÔºàÊåâÈíÆ36 + Èó¥Ë∑ù + ÂÜÖËæπË∑ùÔºâ
          .backgroundColor('#f9f9f9')  // ÂèØÈÄâÔºöÊ∑ªÂä†ËÉåÊôØËâ≤Âå∫ÂàÜÂå∫Âüü
          .borderRadius(8)

          // Á¨¨‰∫åÁªÑÔºöÊãçÊëÑÊ®°ÂºèÂèÇÊï∞ÔºàÊõùÂÖâÊ®°Âºè„ÄÅÂØπÁÑ¶Ê®°ÂºèÔºâ
          Grid() {
            GridItem() { this.buildParamButton('ÊõùÂÖâÊ®°Âºè', this.exposureProgramValue, () =>{this.ExposureMode_DialogController.open() } ) }
            GridItem() { this.buildParamButton('ÂØπÁÑ¶Ê®°Âºè', this.focusModeValue, () => {this.Focus_Mode_DialogController.open() }) }
            GridItem() { this.buildParamButton('ÊµãÂÖâÊ®°Âºè', this.meterModeValue, () => {this.ExposureMeterMode_DialogController.open() }) }
            GridItem() { this.buildParamButton('ÁôΩÂπ≥Ë°°', this.whiteBalanceValue, () => {this.whiteBalance_DialogController.open() }) }
          }
          .columnsTemplate('1fr 1fr 1fr 1fr')
          .columnsGap(8)
          .padding(10)
          .height(80)  // Âõ∫ÂÆöÁ¨¨‰∫åÁªÑÁΩëÊ†ºÈ´òÂ∫¶
          .backgroundColor('#f9f9f9')
          .borderRadius(8)
          .margin({ top: 8 })  // ‰∏§ÁªÑ‰πãÈó¥Ê∑ªÂä†Èó¥Ë∑ù


        }
        .width("100%")
        .padding({ left: 10, right: 10 })  // Â∑¶Âè≥ÁïôËæπÔºåÈÅøÂÖçÂÜÖÂÆπË¥¥Ëæπ




        /**
         * @function È¢ÑËßàÊåâÈíÆÂå∫Âüü
         * */
        Row({ space: 10 }) {
          Button('ÂêØÂä®È¢ÑËßà')
            .enabled(!this.previewRunning)
            .onClick(() => this.startPreview())

          Button('ÂÅúÊ≠¢È¢ÑËßà')
            .enabled(this.previewRunning)
            .onClick(() => this.stopPreview())
        }
        .margin({ top: 10 })


        /**
         *@function ÊãçÁÖßÊåâÈíÆÂå∫Âüü
         * */
        Row({ space: 10 }) {
          Button('ÂõæÂ∫ì')
          Button('ÊãçÁÖß')
            .onClick(() => {
              this.takeAndDownloadKnown()
            })
        }
        .margin({ top: 20 })
      }
      .width("100%")
      .height("100%")
    }
    .title('ÈÅ•ÊéßÊãçÁÖß')
  }
}