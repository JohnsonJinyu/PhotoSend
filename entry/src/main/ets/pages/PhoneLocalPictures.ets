import { socket } from "@kit.NetworkKit";
import { common } from "@kit.AbilityKit";
import  fs  from "@ohos.file.fs"
import { promptAction, UIContext } from "@kit.ArkUI";

// å›¾ç‰‡ä¿¡æ¯æ¨¡å‹
interface ImageInfo {
  uri: string;
  name: string;
  modifyTime: number;
  dateStr: string;
}

@Preview
@Component
export struct PhoneLocalPictures {
  @State images: ImageInfo[] = []
  @State isLoading: boolean = true
  @State appStoragePath: string = ``

  uiContext = this.getUIContext()

  private context = this.uiContext?.getHostContext() as common.UIAbilityContext;

  // é¡µé¢åˆå§‹åŒ–æ—¶è·å–å›¾ç‰‡
  async aboutToAppear() {
    try {
      // è·å–åº”ç”¨æ²™ç®±å­˜å‚¨è·¯å¾„ (API20æ­£ç¡®æ–¹æ³•)
      this.appStoragePath = this.context.cacheDir;

      // åŠ è½½å›¾ç‰‡
      await this.loadImages();
    }catch (error){

      console.error('è·å–å­˜å‚¨è·¯å¾„å¤±è´¥: ' + JSON.stringify(error));
      this.isLoading = false;

    }
  }

  // åŠ è½½å¹¶å¤„ç†å›¾ç‰‡
  async loadImages() {
    try {
      this.isLoading = true;
      const imageFiles: ImageInfo[] = [];

      // è¯»å–ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
      const fileList = await fs.listFile(this.appStoragePath);

      // ç­›é€‰å›¾ç‰‡æ–‡ä»¶å¹¶è·å–ä¿¡æ¯
      for (const fileName of fileList) {
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºå›¾ç‰‡
        if (this.isImageFile(fileName)) {
          const filePath = this.appStoragePath + '/' + fileName;

          // è·å–æ–‡ä»¶ä¿¡æ¯
          const stat = await fs.stat(filePath);

          // ç›´æ¥ä½¿ç”¨stat.mtimeï¼ˆå·²ä¸ºæ—¶é—´æˆ³ï¼‰ï¼Œæ— éœ€è½¬æ¢
          const modifyTime = stat.mtime;

          // æ ¼å¼åŒ–æ—¥æœŸæ—¶å†è½¬æ¢ä¸ºDateå¯¹è±¡
          const dateStr = this.formatDate(new Date(modifyTime));

          imageFiles.push({
            uri: 'file://' + filePath,
            name: fileName,
            modifyTime: modifyTime, // æ–‡ä»¶ä¿®æ”¹æ—¶é—´æˆ³

            dateStr: dateStr
          });
        }
      }

      // æŒ‰ä¿®æ”¹æ—¶é—´æ’åº(æœ€æ–°çš„åœ¨å‰é¢)
      imageFiles.sort((a, b) => b.modifyTime - a.modifyTime);
      this.images = imageFiles;
    } catch (err) {
      console.error('åŠ è½½å›¾ç‰‡å¤±è´¥: ' + JSON.stringify(err));
      //promptAction.showToast({ message: 'åŠ è½½å›¾ç‰‡å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡æ–‡ä»¶
  isImageFile(fileName: string): boolean {
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'];
    const ext = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
    return imageExtensions.includes(ext);
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = this.padZero(date.getMonth() + 1);
    const day = this.padZero(date.getDate());
    const hour = this.padZero(date.getHours());
    const minute = this.padZero(date.getMinutes());
    return `${year}-${month}-${day} ${hour}:${minute}`;
  }

  // æ•°å­—è¡¥é›¶
  padZero(num: number): string {
    return num < 10 ? '0' + num : num.toString();
  }

  // æ—¶é—´è½´èŠ‚ç‚¹ç»„ä»¶
  @Builder TimeLineDot(isFirst: boolean, isLast: boolean) {
    Column() {
      if (!isFirst) {
        Divider()
          .vertical(true)
          .height('100%')
          .color('#DDDDDD')
      }
      Circle()
        .width(12)
        .height(12)
        .fill('#007DFF')
      if (!isLast) {
        Divider()
          .vertical(true)
          .height('100%')
          .color('#DDDDDD')
      }
    }
    .width(12)
  }

  build() {
    Column() {
      // é¡µé¢æ ‡é¢˜
      Row() {
        Text('å›¾ç‰‡æ—¶é—´è½´')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 10, bottom: 10 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)

      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        Progress({ value: 0, type: ProgressType.Capsule })
          .width(40)
          .height(40)
          .margin({ top: 50 })
      }
      // æ— å›¾ç‰‡çŠ¶æ€
      else if (this.images.length === 0) {
        Column() {
          Text('ğŸ“·') // ç”¨ç›¸æœºemojiæ›¿ä»£å›¾ç‰‡
            .fontSize(50)
            .margin({ bottom: 20 })
          Text('æœ¬åœ°æ— å›¾')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .height('80%')
        .justifyContent(FlexAlign.Center)
      }
      // å›¾ç‰‡æ—¶é—´è½´åˆ—è¡¨
      else {
        List({ space: 10 }) {
          ForEach(this.images, (item: ImageInfo, index: number) => {
            ListItem() {
              Row() {
                // æ—¶é—´è½´èŠ‚ç‚¹
                this.TimeLineDot(index === 0, index === this.images.length - 1)

                // å›¾ç‰‡å’Œä¿¡æ¯
                Column() {
                  // æ—¥æœŸæ—¶é—´
                  Text(item.dateStr)
                    .fontSize(14)
                    .fontColor('#666666')
                    .margin({ bottom: 8 })

                  // å›¾ç‰‡
                  Image(item.uri)
                    .width('100%')
                    .height(200)
                    .objectFit(ImageFit.Cover)
                    .borderRadius(8)
                    .margin({ bottom: 8 })

                  // æ–‡ä»¶å
                  Text(item.name)
                    .fontSize(14)
                    .fontColor('#333333')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
                .width('90%')
                .padding({ left: 10 })
              }
              .width('100%')
              .padding({ left: 20, right: 20, top: 5, bottom: 5 })
            }
          }, (item: ImageInfo) => item.uri)
        }
        .width('100%')
        .padding({ top: 10 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')

  }
}

